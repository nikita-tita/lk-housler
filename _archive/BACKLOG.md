# BACKLOG - Полный список доработок lk.housler.ru

**Дата ревью:** 24 декабря 2025
**Версия:** 1.0

---

## АНАЛИЗ ТЕКУЩЕГО СОСТОЯНИЯ

### Что реализовано (Backend)

| Компонент | Статус | Файл |
|-----------|--------|------|
| Deal CRUD | 100% | `services/deal/service.py` |
| Document генерация | 80% | `services/document/service.py` |
| ПЭП через SMS | 90% | `services/signature/service.py` |
| Payment Intent | 70% | `services/payment/service.py` |
| Ledger entries | 60% | `services/ledger/service.py` |
| Antifraud модели | 50% | `models/antifraud.py` |
| KYC модели | 40% | `models/user.py`, `models/organization.py` |

### Что реализовано (Frontend)

| Страница | Статус | Путь |
|----------|--------|------|
| Agent Dashboard | 80% | `/agent/dashboard` |
| Agent Deals List | 90% | `/agent/deals` |
| Create Deal Form | 95% | `/agent/deals/new` |
| Deal Details | 50% | `/agent/deals/[id]` |
| Client Dashboard | 60% | `/client/dashboard` |
| Client Documents | 40% | `/client/documents` |
| Agency Dashboard | 50% | `/agency/dashboard` |

---

## 1. ДОГОВОРЫ И ШАБЛОНЫ

### 1.1 Текущее состояние

**Реализовано:**
- Один шаблон `SECONDARY_BUY_TEMPLATE` в `generator.py:46-139`
- HTML рендеринг с placeholders
- PDF генерация через WeasyPrint
- SHA-256 хеш документа

**Проблемы:**
- Только 1 шаблон (secondary_buy используется для всех типов)
- Нет возможности загрузить свой шаблон
- Шаблон захардкожен в коде, не в БД
- Нет версионирования шаблонов
- Нет полей для реквизитов юрлица исполнителя

### 1.2 Требуемые доработки

| # | Задача | Приоритет | Сложность |
|---|--------|-----------|-----------|
| 1.2.1 | Создать типовые шаблоны для каждого DealType | HIGH | Medium |
| 1.2.2 | Реализовать CRUD для ContractTemplate в БД | HIGH | Medium |
| 1.2.3 | Добавить UI загрузки своего шаблона (Agency Admin) | MEDIUM | High |
| 1.2.4 | Добавить preview документа перед подписанием | HIGH | Medium |
| 1.2.5 | Реализовать версионирование шаблонов | LOW | Low |
| 1.2.6 | Добавить поля реквизитов в шаблон (ИНН, ОГРН, р/с) | HIGH | Low |

### 1.3 Типовые договоры для реализации

```
1. Договор на подбор вторичной недвижимости (покупка)
2. Договор на продажу вторичной недвижимости
3. Договор бронирования новостройки
4. Акт выполненных работ
5. Дополнительное соглашение
6. Соглашение о расторжении
```

---

## 2. ПРОСТАЯ ЭЛЕКТРОННАЯ ПОДПИСЬ (ПЭП)

### 2.1 Текущее состояние

**Реализовано:**
- `SignatureService` с OTP через SMS
- Evidence collection (IP, user_agent, timestamp, document_hash)
- Проверка всех подписей для финализации документа

**Проблемы:**
- Нет отправки SMS клиенту (только агент через agent.housler.ru)
- Нет frontend для клиентской подписи
- Нет ссылки для подписания "без регистрации"
- Evidence не соответствует полностью 63-ФЗ

### 2.2 Требуемые доработки

| # | Задача | Приоритет | Сложность |
|---|--------|-----------|-----------|
| 2.2.1 | Создать публичную страницу подписания `/sign/[token]` | CRITICAL | High |
| 2.2.2 | Генерировать short-link для клиента | CRITICAL | Low |
| 2.2.3 | SMS уведомление клиенту со ссылкой на подпись | CRITICAL | Low |
| 2.2.4 | Добавить согласие на ПЭП (checkbox + timestamp) | HIGH | Low |
| 2.2.5 | Сохранять geolocation в evidence | MEDIUM | Low |
| 2.2.6 | Генерировать сертификат ПЭП (PDF) | MEDIUM | Medium |
| 2.2.7 | Добавить УКЭП интеграцию (Phase 2) | LOW | High |

### 2.3 Формат ссылки для подписания

```
https://lk.housler.ru/sign/{short_token}

Пример: https://lk.housler.ru/sign/Xk9mZ2
```

---

## 3. ПЛАТЕЖИ И СБП

### 3.1 Текущее состояние

**Реализовано:**
- `PaymentSchedule`, `PaymentIntent`, `Payment` модели
- `MockPaymentProvider` для разработки
- Заглушка для `RealPaymentProvider`
- Webhook endpoint `/api/v1/payments/webhook`

**Проблемы:**
- Нет реальной интеграции с банком
- Нет QR-кода для СБП
- Нет проверки статуса платежа
- Нет автоматического split после оплаты
- Нет чеков (Receipt модель есть, но не используется)

### 3.2 Требуемые доработки

| # | Задача | Приоритет | Сложность |
|---|--------|-----------|-----------|
| 3.2.1 | Выбрать и интегрировать СБП провайдера | CRITICAL | High |
| 3.2.2 | Реализовать генерацию QR для оплаты | CRITICAL | Medium |
| 3.2.3 | Реализовать polling статуса платежа | HIGH | Medium |
| 3.2.4 | Автоматический split после успешной оплаты | HIGH | Medium |
| 3.2.5 | Интеграция с онлайн-кассой (54-ФЗ) | HIGH | High |
| 3.2.6 | Генерация чеков | HIGH | Medium |
| 3.2.7 | Возвраты (refund) | MEDIUM | Medium |

### 3.3 Варианты СБП провайдеров

```
1. Тинькофф Бизнес API - рекомендуется
   - Хорошая документация
   - Split-платежи из коробки
   - Онлайн-касса

2. Сбербанк Эквайринг
   - Широкое покрытие
   - Сложнее интеграция

3. ЮKassa (Yandex)
   - Простая интеграция
   - Нет split-платежей (нужен маркетплейс)

4. CloudPayments
   - Быстрое подключение
   - Хорошая документация
```

---

## 4. ВЫПЛАТЫ АГЕНТАМ (PAYOUTS)

### 4.1 Текущее состояние

**Реализовано:**
- `Split` модель со статусами
- `Payout` модель
- `PayoutAccount` для реквизитов
- Логика расчета split в `LedgerService`

**Проблемы:**
- Нет реальных выплат
- Нет верификации реквизитов
- Нет hold для новых агентов
- Нет интеграции с банком для выплат

### 4.2 Требуемые доработки

| # | Задача | Приоритет | Сложность |
|---|--------|-----------|-----------|
| 4.2.1 | Интеграция с банком для выплат | HIGH | High |
| 4.2.2 | Верификация банковских реквизитов | HIGH | Medium |
| 4.2.3 | Hold period для новых агентов | HIGH | Low |
| 4.2.4 | UI для просмотра баланса и выплат | HIGH | Medium |
| 4.2.5 | Автоматические выплаты по расписанию | MEDIUM | Medium |
| 4.2.6 | Ручные выплаты (Admin) | MEDIUM | Low |

---

## 5. KYC И ВЕРИФИКАЦИЯ

### 5.1 Текущее состояние

**Реализовано:**
- `VerificationLevel` enum (NONE, SIMPLIFIED, STANDARD, FULL)
- `KYCStatus` для организаций
- Поля для паспортных данных (encrypted)
- Поле `inn` для самозанятых

**Проблемы:**
- Нет автоматической проверки паспорта
- Нет проверки ИНН через ФНС
- Нет проверки статуса самозанятого
- Нет проверки в списках Росфинмониторинга
- Нет UI для загрузки документов

### 5.2 Требуемые доработки

| # | Задача | Приоритет | Сложность |
|---|--------|-----------|-----------|
| 5.2.1 | Интеграция с ФНС (проверка ИНН) | HIGH | Medium |
| 5.2.2 | Интеграция с API самозанятых (НПД) | HIGH | Medium |
| 5.2.3 | UI загрузки паспорта/документов | HIGH | Medium |
| 5.2.4 | OCR паспортных данных | MEDIUM | High |
| 5.2.5 | Проверка МВД (недействительные паспорта) | MEDIUM | Medium |
| 5.2.6 | Проверка Росфинмониторинг (115-ФЗ) | LOW | High |

### 5.3 Лимиты по уровням верификации

```
NONE (0):        до 0 руб (нельзя создавать сделки)
SIMPLIFIED (1):  до 15,000 руб/сделка
STANDARD (2):    до 600,000 руб/сделка
FULL (3):        без ограничений
```

---

## 6. FRONTEND - НЕДОСТАЮЩИЕ СТРАНИЦЫ

### 6.1 Agent Console

| Страница | Статус | Что нужно |
|----------|--------|-----------|
| `/agent/deals/[id]` | 50% | Детали сделки, статусы, документы |
| `/agent/deals/[id]/sign` | 0% | Подписание агентом |
| `/agent/profile` | 60% | Редактирование профиля, KYC |
| `/agent/finance` | 0% | Баланс, выплаты, история |
| `/agent/settings` | 0% | Настройки аккаунта |

### 6.2 Client Portal

| Страница | Статус | Что нужно |
|----------|--------|-----------|
| `/client/dashboard` | 60% | Список сделок клиента |
| `/client/deals/[id]` | 40% | Детали сделки |
| `/client/documents` | 40% | Список документов |
| `/sign/[token]` | 0% | **КРИТИЧНО** - Подписание без регистрации |

### 6.3 Agency Admin

| Страница | Статус | Что нужно |
|----------|--------|-----------|
| `/agency/dashboard` | 50% | Статистика агентства |
| `/agency/agents` | 40% | Управление агентами |
| `/agency/deals` | 40% | Все сделки агентства |
| `/agency/finance` | 30% | Финансы, выплаты |
| `/agency/settings` | 20% | Настройки, шаблоны договоров |
| `/agency/templates` | 0% | Управление шаблонами |

---

## 7. УВЕДОМЛЕНИЯ

### 7.1 Текущее состояние

**Реализовано:**
- SMS провайдер (SMS.RU)
- Email провайдер (SMTP/SendGrid)
- OTP для авторизации

**Проблемы:**
- Нет уведомлений о событиях сделки
- Нет email templates
- Нет push уведомлений
- Нет telegram бота

### 7.2 Требуемые доработки

| # | Задача | Приоритет | Сложность |
|---|--------|-----------|-----------|
| 7.2.1 | SMS клиенту при создании сделки | CRITICAL | Low |
| 7.2.2 | SMS со ссылкой на подписание | CRITICAL | Low |
| 7.2.3 | Email уведомления агенту | HIGH | Medium |
| 7.2.4 | Email templates (HTML) | HIGH | Medium |
| 7.2.5 | Push уведомления (PWA) | LOW | High |
| 7.2.6 | Telegram бот для агентов | LOW | Medium |

---

## 8. ANTIFRAUD

### 8.1 Текущее состояние

**Реализовано:**
- Модели: `AntiFraudCheck`, `UserLimit`, `Blacklist`
- Типы проверок в enum
- Настройки лимитов в config

**Проблемы:**
- Нет реальных проверок
- Нет автоматического применения лимитов
- Нет UI для blacklist

### 8.2 Требуемые доработки

| # | Задача | Приоритет | Сложность |
|---|--------|-----------|-----------|
| 8.2.1 | Velocity check (частота сделок) | HIGH | Medium |
| 8.2.2 | Amount limit check | HIGH | Low |
| 8.2.3 | Автоматический hold для новых агентов | HIGH | Low |
| 8.2.4 | IP/Device fingerprint | MEDIUM | Medium |
| 8.2.5 | Admin UI для blacklist | MEDIUM | Low |
| 8.2.6 | Manual review queue | LOW | Medium |

---

## 9. ИНТЕГРАЦИИ (ВНЕШНИЕ СЕРВИСЫ)

### 9.1 Необходимые интеграции

| Сервис | Назначение | Приоритет | Статус |
|--------|------------|-----------|--------|
| СБП (Тинькофф/Сбер) | Прием платежей | CRITICAL | 0% |
| ФНС API | Проверка ИНН | HIGH | 0% |
| Мой Налог API | Статус самозанятого | HIGH | 0% |
| Онлайн-касса | Чеки 54-ФЗ | HIGH | 0% |
| МВД (паспорта) | KYC | MEDIUM | 0% |
| DaData | Подсказки адресов | MEDIUM | 0% |
| SMS.RU | SMS | HIGH | 100% |
| Yandex SMTP | Email | HIGH | 100% |
| MinIO | Файлы | HIGH | 100% |

---

## 10. ПРИОРИТИЗИРОВАННЫЙ ROADMAP

### Phase 1: MVP (2-3 недели)

```
[x] Backend API (deals, documents, signatures)
[x] Frontend базовые страницы
[ ] Публичная страница подписания /sign/[token]
[ ] SMS клиенту со ссылкой
[ ] Preview документа
[ ] Типовые шаблоны договоров (3 шт)
```

### Phase 2: Платежи (2-3 недели)

```
[ ] Интеграция СБП
[ ] QR код для оплаты
[ ] Webhook обработка
[ ] Split после оплаты
[ ] Онлайн-касса
```

### Phase 3: KYC (1-2 недели)

```
[ ] ФНС интеграция
[ ] Проверка самозанятых
[ ] UI загрузки документов
[ ] Лимиты по уровням
```

### Phase 4: Выплаты (2 недели)

```
[ ] Интеграция с банком
[ ] Автоматические выплаты
[ ] UI баланса
[ ] Hold period
```

### Phase 5: Agency Features (2 недели)

```
[ ] Управление шаблонами
[ ] Статистика
[ ] Управление агентами
[ ] Финансовые отчеты
```

---

## КРИТИЧЕСКИЕ БЛОКЕРЫ

1. **Нет страницы подписания для клиента** - без этого сделки не могут быть подписаны
2. **Нет СБП интеграции** - нельзя принимать платежи
3. **Один шаблон договора** - не покрывает все типы сделок

---

## ТЕХНИЧЕСКИЙ ДОЛГ

| Проблема | Файл | Приоритет |
|----------|------|-----------|
| Deprecated plain PII fields | `models/user.py` | HIGH |
| recipient_id как UUID вместо Integer | `models/ledger.py:73` | MEDIUM |
| Нет refresh token endpoint | `api/v1/auth/*` | HIGH |
| Нет rate limiting | `main.py` | MEDIUM |
| Нет Sentry | `main.py` | LOW |
| Нет background tasks (Celery) | - | MEDIUM |
| Redis без пароля в prod | `docker-compose.prod.yml` | HIGH |
| Backend от root | `Dockerfile` | HIGH |

---

**Общая оценка готовности к production: 35%**

Основные блокеры - публичное подписание и платежи.
