# Bank-Split: Анализ пробелов и план доработок

**Дата:** 2026-01-17
**Обновлено:** 2026-01-17 (v4 — Phase 0 fixes completed)
**Статус:** НА СОГЛАСОВАНИЕ

---

## ТЕКУЩЕЕ СОСТОЯНИЕ

### Что реализовано (95%)

**Backend:**
- Backend API (8 endpoints)
- State machine сделок
- T-Bank интеграция (mock + production ready)
- Split calculation
- Webhook обработка
- Celery tasks (hold expiry, reconciliation)
- 111 unit tests

**Frontend (после UI тестирования):**
- Landing page с выбором ролей (Клиент/Риелтор/Агентство)
- 3 разных auth flow (Phone OTP / Email OTP / Password)
- Bank-split форма создания сделки (4 шага)
- **Страница подписания `/sign/[token]`** — ПЭП через SMS OTP работает!
- **Страница оплаты `/pay/[dealId]`** — QR код + кнопка оплаты работают!

### Что НЕ реализовано
- Приглашение партнёров в сделку
- Уведомления участникам (SMS/Email)
- Информирование о комиссии
- Согласие на условия
- Механизм споров и возвратов
- Frontend (кроме payment page)
- F.Doc интеграция для ПЭП (вместо внутренней SMS-подписи)
- SMS-ссылка клиенту на подписание договора
- SMS-ссылка клиенту на оплату после подписания

---

## РЕЗУЛЬТАТЫ ТЕСТИРОВАНИЯ (2026-01-17)

### API Endpoints — Статус

| Endpoint | Метод | Результат | Примечание |
|----------|-------|-----------|------------|
| `/health` | GET | OK | Работает |
| `/api/v1/bank-split/webhooks/tbank` | POST | `{"Success":true}` | Работает |
| `/api/v1/bank-split` | POST | 401 | Требует auth — корректно |
| `/api/v1/deals` | GET | 401 | Требует auth — корректно |
| `/api/v1/sign/{token}` | GET | 404 | ✅ Исправлено (было 500) |
| `/api/v1/bank-split/{id}/send-payment-link` | POST | OK | ✅ Новый endpoint |

### UI Pages — Статус

| Страница | URL | Статус | Примечание |
|----------|-----|--------|------------|
| Landing | `/` | ✅ OK | 3 роли, cookie banner |
| Auth Realtor | `/realtor` | ✅ OK | Phone + SMS OTP |
| Auth Client | `/client` | ✅ OK | Email + Email OTP |
| Auth Agency | `/agency` | ✅ OK | Email + Password |
| Bank-split form | `/agent/deals/bank-split/new` | ⚠️ GAPS | См. ниже |
| Sign page | `/sign/[token]` | ✅ OK | ПЭП работает! |
| Payment page | `/pay/[dealId]` | ✅ OK | QR + URL работают |

### Проблемы в Bank-split форме (найдено при UI тесте)

| Проблема | Описание | GAP | Статус |
|----------|----------|-----|--------|
| **Нет комиссии 4%** | В форме нигде не показана комиссия платформы | GAP-002 | ✅ Исправлено |
| **Нет согласия** | Нет checkbox для согласия на комиссию | GAP-003 | ✅ Исправлено |
| **Со-агент по ID** | Нужно вводить ID вручную, нет поиска/приглашения | GAP-001 | В работе |

### Обнаруженные баги

#### BUG-001: Sign endpoint 500 вместо 404 ✅ ИСПРАВЛЕНО
**Severity:** Low
**Endpoint:** `GET /api/v1/sign/{invalid_token}`
**Ожидаемый результат:** 404 Not Found
**Фактический результат:** ~~500 Internal Server Error~~ → 404 Not Found
**Файл:** `backend/app/api/v1/endpoints/sign.py:36-55`
**Решение:** Добавлен try-except для обработки ошибок БД

#### BUG-002: Bank-split форма — отсутствует комиссия сервиса ✅ ИСПРАВЛЕНО
**Severity:** High (блокер для запуска)
**Страница:** `/agent/deals/bank-split/new`
**Проблема:** ~~В форме создания сделки нигде не показана комиссия платформы 4%~~
**Файл:** `frontend/app/agent/deals/bank-split/new/page.tsx`
**Решение:** Добавлен расчёт и отображение комиссии 4% + checkbox согласия

---

## ВЫЯВЛЕННЫЕ ПРОБЕЛЫ (GAPS)

### P0 — КРИТИЧЕСКИЕ (блокируют запуск)

#### GAP-000: F.Doc интеграция для ПЭП (ПЕРЕСМОТРЕНО)

**ВАЖНО:** После UI тестирования выяснилось, что **ПЭП уже работает** через внутреннюю SMS-верификацию на странице `/sign/[token]`. Клиент даёт 2 согласия и подтверждает кодом из SMS.

**Варианты развития:**

| Вариант | Описание | Оценка |
|---------|----------|--------|
| A. Оставить как есть | Текущая ПЭП достаточна для MVP | 0 дней |
| B. Улучшить текущую | Добавить хранение документов, audit trail | 3-5 дней |
| C. Интегрировать F.Doc | Внешний сервис с юр. гарантиями | 7-10 дней |

**Рекомендация:** Вариант A или B для MVP, F.Doc — в будущем при масштабировании.

**Если выбран F.Doc:**
- F.Doc API: https://fdoc.ru/integration/api
- Требуется: API Key, модель `FDocDocument`, webhooks
- Плюс: внешние юр. гарантии, хранение документов
- Минус: зависимость от внешнего сервиса, стоимость

**Оценка:** 0-10 дней (зависит от выбранного варианта)

---

#### GAP-000.1: Доставка ссылки на оплату клиенту ✅ РЕАЛИЗОВАНО

**ВАЖНО:** Страница оплаты `/pay/[dealId]` **уже работает** — показывает QR код и кнопку "Перейти к оплате".

**User Story:**
> Как клиент, после подписания договора я хочу получить ссылку на оплату

**Текущее состояние:**
- ✅ Payment page готова (QR + URL)
- ✅ API endpoint для отправки SMS клиенту
- ✅ Кнопка "Отправить SMS" на странице сделки агента
- ✅ QR код отображается на странице сделки агента

**Реализация:**

| Компонент | Файл |
|-----------|------|
| API endpoint | `backend/app/api/v1/endpoints/bank_split.py` (send-payment-link) |
| Frontend button | `frontend/app/agent/deals/bank-split/[id]/page.tsx` |
| SMS provider | `backend/app/services/sms/provider.py` (SMS.RU) |

**Статус:** ✅ Завершено

---

#### GAP-001: Приглашение партнёра в сделку
**Проблема:** Агент не может пригласить коллегу/партнёра для совместной сделки

**User Story:**
> Как агент, я хочу пригласить коллегу в сделку по SMS, чтобы мы могли разделить комиссию

**Требуется:**
- Модель `DealInvitation` (deal_id, phone, role, split_percent, status)
- API: `POST /bank-split/{id}/invite` — отправить приглашение
- API: `POST /invitations/{id}/accept` — принять
- API: `POST /invitations/{id}/decline` — отклонить
- SMS уведомление с deep link
- Статус сделки `awaiting_confirmations` пока есть незакрытые приглашения

**Оценка:** 5-7 дней

---

#### GAP-002: Информирование о комиссии сервиса
**Проблема:** Клиент/агент не видит сколько составит комиссия платформы

**User Story:**
> Как агент, я хочу видеть комиссию сервиса (4%) до создания сделки, чтобы понимать итоговую сумму

**Требуется:**
- Показать breakdown на UI: сумма сделки → комиссия 4% → итого к оплате
- Добавить поле `platform_fee_percent` в response
- Показать на payment page: "Комиссия сервиса: X руб."

**Оценка:** 1-2 дня

---

#### GAP-003: Согласие на комиссию
**Проблема:** Нет юридического согласия агента на комиссию перед созданием сделки

**User Story:**
> Как платформа, я требую от агента подтверждение согласия на комиссию 4%

**Требуется:**
- Модель `DealConsent` (deal_id, user_id, consent_type, agreed_at, ip_address)
- Enum `ConsentType`: PLATFORM_COMMISSION, DATA_PROCESSING, TERMS
- Checkbox на UI: "Я ознакомлен и согласен с комиссией сервиса 4%"
- API: `POST /bank-split/{id}/consent`
- Проверка: нельзя создать invoice без согласия

**Оценка:** 2-3 дня

---

#### GAP-004: Уведомления участникам
**Проблема:** Участники сделки не получают уведомления о статусах

**User Story:**
> Как участник сделки, я хочу получать SMS/Email при изменении статуса

**События для уведомлений:**
| Событие | Получатели |
|---------|------------|
| Сделка создана | Все участники |
| Приглашение отправлено | Приглашённый |
| Приглашение принято | Создатель |
| Сделка на подписании | Все участники |
| Сделка подписана | Клиент |
| Оплата получена | Все агенты |
| Холд завершён, выплата | Получатели выплат |
| Сделка отменена | Все участники |

**Требуется:**
- EventBus для deal events
- NotificationHandler с шаблонами
- SMS templates
- Email templates
- Retry логика

**Оценка:** 5-7 дней

---

#### GAP-005: Механизм споров и возвратов
**Проблема:** Нет способа оспорить сделку или запросить возврат

**User Story:**
> Как клиент/агент, я хочу оспорить сделку в период холда, если что-то пошло не так

**Требуется:**
- Модель `Dispute` (deal_id, initiator, reason, evidence, status)
- API: `POST /bank-split/{id}/dispute`
- Статус сделки `disputed`
- Приостановка холда до разрешения
- Refund логика через T-Bank API
- Admin panel для модерации споров

**Оценка:** 7-10 дней

---

### P1 — ВАЖНЫЕ (улучшают UX)

#### GAP-006: Подтверждение выполнения услуги
**Проблема:** Release из холда происходит автоматически по времени, без подтверждения

**User Story:**
> Как агент, я хочу подтвердить выполнение услуги, чтобы ускорить выплату

**Требуется:**
- API: `POST /bank-split/{id}/confirm-completion`
- Модель `ServiceCompletion` (deal_id, confirmed_by, evidence_files)
- Условие release: timeout OR все подтвердили
- Загрузка evidence (фото, документы)

**Оценка:** 3-5 дней

---

#### GAP-007: Настройка пропорций сплита
**Проблема:** Сейчас пропорции задаются при создании, нет UI для их настройки

**User Story:**
> Как агент, я хочу предложить партнёру пропорции 60/40 и дождаться его согласия

**Требуется:**
- UI для выбора процентов
- Согласование от обеих сторон
- История изменений пропорций
- Валидация: сумма = 100%

**Оценка:** 3-4 дня

---

#### GAP-008: Корректировки после оплаты
**Проблема:** Нельзя изменить split после получения оплаты

**User Story:**
> Как агент, я хочу скорректировать пропорции, если выяснились новые обстоятельства

**Требуется:**
- Модель `SplitAdjustment` (deal_id, old_split, new_split, reason, status)
- API: `POST /bank-split/{id}/adjust-split`
- Требует согласия обеих сторон
- Audit trail

**Оценка:** 4-5 дней

---

#### GAP-009: Валидация данных получателей
**Проблема:** INN не валидируется, нет проверки по реестрам

**Требуется:**
- Валидация контрольной суммы INN
- Проверка статуса самозанятого в ФНС
- Blacklist checking

**Оценка:** 2-3 дня

---

#### GAP-010: Договор с агентом
**Проблема:** Нет формализованного договора об условиях работы

**Требуется:**
- Система шаблонов договоров
- Электронная подпись агента
- Версионирование
- Привязка к сделке

**Оценка:** 5-7 дней

---

### P2 — ЖЕЛАТЕЛЬНЫЕ (nice to have)

#### GAP-011: Dashboard агента
**Проблема:** Нет UI для просмотра истории сделок

#### GAP-012: Admin panel
**Проблема:** Нет интерфейса администратора

#### GAP-013: Аналитика и отчёты
**Проблема:** Нет статистики по сделкам

---

## ПЛАН РЕАЛИЗАЦИИ

### PHASE 0: Quick Wins (неделя 1) ✅ ЗАВЕРШЕНО
**Цель:** Исправить критические пробелы в UI, доставка ссылки на оплату

| Задача | Приоритет | Статус | Файлы |
|--------|-----------|--------|-------|
| BUG-002: Добавить комиссию 4% в форму | P0 | ✅ | `frontend/app/agent/deals/bank-split/new/page.tsx` |
| GAP-003: Checkbox согласия на комиссию | P0 | ✅ | `frontend/app/agent/deals/bank-split/new/page.tsx` |
| GAP-000.1: SMS доставка ссылки оплаты | P0 | ✅ | `backend/app/api/v1/endpoints/bank_split.py`, `frontend/.../[id]/page.tsx` |
| BUG-001: Fix sign endpoint 500 | Low | ✅ | `backend/app/api/v1/endpoints/sign.py` |

**Итого:** Завершено 2026-01-17

**Примечание:** ПЭП уже работает! F.Doc — опционально на будущее

---

### PHASE 1: Compliance (неделя 2)
**Цель:** Юридическая готовность к запуску

| Задача | Приоритет | Дни | Ответственный |
|--------|-----------|-----|---------------|
| GAP-002: Информирование о комиссии | P0 | 1-2 | BE-LK |
| GAP-003: Согласие на комиссию | P0 | 2-3 | BE-LK |
| GAP-009: Валидация INN | P1 | 2 | BE-LK |

**Итого:** 5-7 дней

---

### PHASE 2: Multi-Agent (неделя 3-4)
**Цель:** Поддержка сделок с несколькими агентами

| Задача | Приоритет | Дни | Ответственный |
|--------|-----------|-----|---------------|
| GAP-001: Приглашение партнёра | P0 | 5-7 | BE-LK + FE-LK |
| GAP-007: Настройка пропорций | P1 | 3-4 | FE-LK |
| GAP-004: Уведомления (SMS) | P0 | 3-4 | BE-LK |

**Итого:** 11-15 дней

---

### PHASE 3: Reliability (неделя 5-6)
**Цель:** Обработка edge cases

| Задача | Приоритет | Дни | Ответственный |
|--------|-----------|-----|---------------|
| GAP-005: Споры и возвраты | P0 | 7-10 | BE-LK + INTEG-LK |
| GAP-006: Подтверждение услуги | P1 | 3-5 | BE-LK |
| GAP-008: Корректировки | P1 | 4-5 | BE-LK |

**Итого:** 14-20 дней

---

### PHASE 4: Legal & UX (неделя 7+)
**Цель:** Полный compliance и UX

| Задача | Приоритет | Дни | Ответственный |
|--------|-----------|-----|---------------|
| GAP-010: Договор с агентом | P1 | 5-7 | BE-LK + Legal |
| GAP-004: Уведомления (Email) | P1 | 2-3 | BE-LK |
| GAP-011-13: Dashboard, Admin | P2 | 15-20 | FE-LK |

**Итого:** 22-30 дней

---

## TIMELINE (ОБНОВЛЕНО)

```
Янв 20 ────────────────────────────────────────────────────── Мар 15

PHASE 0: Quick Wins (UI fixes, payment delivery)
[██████] 4-6 дней
        │
        ▼
PHASE 1: Compliance
        [████████] 5-7 дней
                  │
                  ▼
PHASE 2: Multi-Agent
                  [████████████████] 11-15 дней
                                    │
                                    ▼
PHASE 3: Reliability
                                    [████████████████████] 14-20 дней
                                                          │
                                                          ▼
PHASE 4: Legal & UX
                                                          [████████████...] 22-30 дней
```

**Общая оценка:** 56-78 дней (~2-3 месяца)

**Примечание:** Timeline сократился на ~1 неделю т.к. ПЭП и Payment page уже работают!

---

## ВОПРОСЫ ДЛЯ СОГЛАСОВАНИЯ

### F.Doc интеграция (НОВЫЕ)

7. **F.Doc тариф** — какой тариф нужен? (стандарт/бизнес/enterprise)

8. **F.Doc credentials** — кто запрашивает доступ? (sales@fdoc.ru)

9. **Сохранение текущей ПЭП** — оставить как fallback или полностью заменить на F.Doc?

10. **Соглашение об ЭДО** — F.Doc требует подписания соглашения с клиентом. Включить в договор автоматически?

### Доставка ссылки на оплату (НОВЫЕ)

11. **Способ доставки ссылки на оплату** — SMS, QR, Email? Или выбор агента?

12. **Автоматическая отправка** — отправлять SMS сразу после подписания или по команде агента?

### Ранее заданные

1. **Комиссия 4%** — это финальная цифра? Нужна ли возможность менять для разных типов сделок?

2. **Приглашение по SMS** — достаточно ли SMS или нужен также WhatsApp/Telegram?

3. **Споры** — кто модерирует? Нужен ли арбитраж или решает платформа?

4. **Договор с агентом** — есть ли готовый шаблон от юристов?

5. **Hold period** — сейчас 1 час. Нужна ли гибкость (разные периоды для разных типов)?

6. **Минимальная сумма сделки** — есть ли ограничение снизу?

---

## РИСКИ

| Риск | Вероятность | Влияние | Митигация |
|------|-------------|---------|-----------|
| T-Bank API изменится | Низкая | Высокое | Версионирование, contract tests |
| Юридические требования | Средняя | Высокое | Раннее привлечение юристов |
| Споры без модератора | Высокая | Среднее | Автоматические правила + эскалация |
| SMS не доходят | Средняя | Среднее | Retry + fallback на email |
| F.Doc недоступен | Низкая | Высокое | Fallback на внутреннюю ПЭП |
| F.Doc долгий onboarding | Средняя | Среднее | Начать процесс заблаговременно |
| F.Doc изменит API | Низкая | Среднее | Версионирование, мониторинг changelog |

---

## СЛЕДУЮЩИЕ ШАГИ

### Немедленно (эта неделя) — после UI тестирования
1. [ ] **Согласовать этот документ** с Product Owner
2. [x] **BUG-002 (КРИТИЧНО):** Добавить показ комиссии 4% в bank-split форму ✅
3. [x] **GAP-003:** Добавить checkbox согласия на комиссию ✅
4. [x] **BUG-001:** Исправить sign endpoint 500 → 404 ✅

### После согласования
5. [x] Реализовать отправку SMS со ссылкой на оплату ✅
6. [x] Добавить QR код на страницу сделки агента ✅ (уже был)
7. [ ] Получить T-Bank sandbox credentials

### F.Doc — опционально (после MVP)
8. [ ] Связаться с F.Doc если нужна внешняя ПЭП
9. [ ] Текущая ПЭП через SMS достаточна для MVP

---

## ССЫЛКИ

- **F.Doc API:** https://fdoc.ru/integration/api
- **F.Doc Spec:** https://demo.fdoc.ru/spec/
- **F.Doc База знаний:** https://fdoc.ru/d/knowledge-base/
- **T-Bank Instant Split:** (internal docs)

---

*Документ подготовлен: 2026-01-17*
*Обновлён: 2026-01-17 (v4 — Phase 0 fixes completed)*
*Требует согласования: Product Owner, Legal, CEO*

**Ключевые выводы:**
- ✅ Phase 0 (Quick Wins) полностью завершён
- ✅ BUG-001: Sign endpoint 500→404 исправлен
- ✅ BUG-002: Комиссия 4% добавлена в форму
- ✅ GAP-003: Checkbox согласия добавлен
- ✅ GAP-000.1: SMS доставка ссылки на оплату реализована
- ПЭП уже работает (F.Doc не критичен для MVP)
- Следующий этап: Phase 1 (Compliance) — валидация INN, backend согласия
