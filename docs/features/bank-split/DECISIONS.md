# Бизнес-решения: Bank Split

**Дата:** 2026-01-16
**Статус:** ЧАСТИЧНО ПРИНЯТО

---

## Принятые решения

### 1. Модель монетизации
**Решение:** Revshare с Т-Банком (комиссия от банка)

**Детали:**
- Housler получает долю от комиссии банка за транзакции
- НЕ становимся участником сплита в v1
- Вариант "участник договора" отложен на v2

**Влияние на архитектуру:**
- НЕ нужна таблица `platform_fee_recipient`
- НЕ нужен расчет комиссии Housler
- Упрощается сплит (только agent/agency)

---

### 2. Договор с Т-Банком
**Решение:** В процессе (на владельце продукта)

**Статус credentials:**
- Sandbox: TODO (получить)
- Production: TODO (после договора)

**Архитектура:** Делаем на основе публичной документации T-API

---

### 3. Модель расчетов
**Решение:** INSTANT SPLIT (не escrow)

**Суть:**
- Договор подписывается → фиксирует условия
- К договору выставляется счет
- Клиент оплачивает счет
- Деньги сразу распределяются (макс 1 час холда для оспаривания)
- НЕТ долгого холда, НЕТ ручного подтверждения "услуга оказана"

**Влияние:**
- Убираем статус `WAITING_FOR_CONFIRM`
- Убираем SLA подтверждения
- Авто-release после короткого холда

---

### 4. Политика корректировок после оплаты
**Решение:** Разработано (см. ниже)

---

### 5. White-label
**Решение:** НЕ ДЕЛАЕМ в v1

Клиент увидит что платеж через Т-Банк. Это ок.

---

## Политика корректировок (детально)

### Принципы

1. **До оплаты** — можно менять всё
2. **После оплаты** — минимум изменений, максимум аудита
3. **Деньги в банке** — любое изменение суммы = новая операция

### Сценарии

#### A. Корректировка ДО оплаты

| Что можно | Как | Ограничения |
|-----------|-----|-------------|
| Сумма сделки | Редактирование | Пересчет сплита |
| Участники сплита | Добавить/удалить | Сумма долей = 100% |
| Условия этапов | Редактирование | - |
| Отмена сделки | Кнопка "Отменить" | Статус -> CANCELLED |

**Версионирование:** Каждое изменение = новая версия условий в `deal_terms_history`

#### B. После оплаты: клиент заплатил МЕНЬШЕ

| Сценарий | Решение | Действие |
|----------|---------|----------|
| Частичная оплата | Доплата | Новый этап/milestone |
| Ошибка клиента | Доплата | Новая ссылка на оплату |

**Технически:**
```
Original deal: 100,000 руб -> клиент заплатил 80,000

Вариант 1 (этапы):
  - Этап 1: 80,000 (PAID)
  - Этап 2: 20,000 (READY_TO_PAY) <- новая ссылка

Вариант 2 (доп. сделка):
  - Deal 1: 80,000 (PAID, WAITING_FOR_CONFIRM)
  - Deal 2: 20,000 (linked to Deal 1) <- parent_deal_id
```

#### C. После оплаты: клиент заплатил БОЛЬШЕ

| Сценарий | Решение | Действие |
|----------|---------|----------|
| Переплата | Частичный возврат | Через банк API (если поддерживается) |
| Двойная оплата | Полный возврат второго | Алерт + возврат |

**Ограничение:** Возврат только если банк поддерживает. Иначе — вручную.

#### D. После оплаты: изменение участников сплита

| Сценарий | Решение | Обоснование |
|----------|---------|-------------|
| Добавить участника | ЗАПРЕЩЕНО | Деньги уже распределены |
| Убрать участника | ЗАПРЕЩЕНО | Деньги уже распределены |
| Изменить доли | ЗАПРЕЩЕНО | Деньги уже распределены |

**Workaround:** Отменить сделку (если возможно) и создать новую.

#### E. После оплаты: отмена сделки

| Статус сделки | Можно отменить? | Действие |
|---------------|-----------------|----------|
| PAID_TO_BANK | Да (до release) | Возврат клиенту |
| WAITING_FOR_CONFIRM | Да (до release) | Возврат клиенту |
| RELEASED_PAID_OUT | НЕТ | Деньги уже у участников |

**Возврат:** Через API банка `POST /deals/{id}/cancel`

#### F. После release: споры

| Сценарий | Решение | Кто платит |
|----------|---------|------------|
| Клиент недоволен | Вне платформы | Агент/агентство |
| Chargeback (карты) | Банк списывает | С получателя |
| Мошенничество | Блокировка + расследование | Виновный |

**Позиция Housler:** После release деньги у получателей. Споры решаются между сторонами. Housler предоставляет evidence pack (документы, подписи, логи).

### Матрица разрешений

```
                          ДО ОПЛАТЫ    ПОСЛЕ ОПЛАТЫ    ПОСЛЕ RELEASE
                          ----------   -------------   --------------
Изменить сумму            [x] Да       [ ] Нет*        [ ] Нет
Изменить участников       [x] Да       [ ] Нет         [ ] Нет
Изменить доли             [x] Да       [ ] Нет         [ ] Нет
Добавить этап             [x] Да       [x] Да          [ ] Нет
Отменить сделку           [x] Да       [x] Да**        [ ] Нет
Сделать возврат           [ ] N/A      [x] Да**        [ ] Нет***

* Только через доплату (новый этап)
** До release
*** Только через спор вне платформы
```

### Аудит изменений

Все изменения логируются:

```python
class DealChangeLog(BaseModel):
    deal_id: UUID
    change_type: str  # 'terms_updated', 'participant_added', 'cancelled'
    changed_by_user_id: int
    changed_at: datetime
    old_value: dict
    new_value: dict
    reason: str  # обязательно для изменений после создания
    ip_address: str
    user_agent: str
```

### UI/UX рекомендации

1. **До оплаты:** Свободное редактирование, кнопка "Сохранить изменения"
2. **После оплаты:** Предупреждение "Сделка оплачена. Изменения ограничены."
3. **Доплата:** Кнопка "Добавить этап оплаты"
4. **Отмена:** Подтверждение + причина (обязательно)
5. **После release:** Только просмотр + история

---

## Открытые вопросы

| # | Вопрос | Статус |
|---|--------|--------|
| 1 | ~~SLA подтверждения~~ | РЕШЕНО: Instant Split, не нужен |
| 2 | Поддерживает ли Т-Банк частичный возврат | Уточнить в документации |
| 3 | Лимиты на сумму сделки (min/max) | Уточнить в договоре |
| 4 | Точное время холда (1 час или меньше) | Уточнить в договоре |

---

*Создано: 2026-01-16*
