# LK Housler — Полное руководство по тестированию

**Версия:** 1.0
**Дата:** 2026-01-19

---

## Содержание

1. [Обзор системы](#обзор-системы)
2. [Тестовые данные](#тестовые-данные)
3. [Роли пользователей](#роли-пользователей)
4. [Сценарии тестирования](#сценарии-тестирования)
5. [API Endpoints](#api-endpoints)
6. [Бизнес-логика Bank-Split](#бизнес-логика-bank-split)
7. [Интеграции](#интеграции)
8. [Чек-листы](#чек-листы)

---

## Обзор системы

**LK Housler** — личный кабинет для проведения безопасных сделок с недвижимостью с автоматическим распределением комиссии (Bank-Split / Instant Split).

### Архитектура

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│   lk.housler.ru │────>│ agent.housler.ru│────>│   PostgreSQL    │
│    (Next.js)    │     │   (Auth API)    │     │ (housler_agent) │
└────────┬────────┘     └─────────────────┘     └─────────────────┘
         │
         │ API calls
         ▼
┌─────────────────┐     ┌─────────────────┐
│   LK Backend    │────>│     T-Bank      │
│    (FastAPI)    │     │   (Payments)    │
└─────────────────┘     └─────────────────┘
```

### URL

| Среда | Frontend | Backend API |
|-------|----------|-------------|
| Production | https://lk.housler.ru | https://lk.housler.ru/api/v1 |
| Development | http://localhost:3000 | http://localhost:8000/api/v1 |

---

## Тестовые данные

### SMS авторизация (Агенты / Риелторы)

| Телефон | Код | Роль |
|---------|-----|------|
| `79999111111` | `111111` | agent |
| `79999222222` | `222222` | agent |
| `79999333333` | `333333` | agent |
| `79999444444` | `444444` | agent |
| `79999555555` | `555555` | agent |
| `79999666666` | `666666` | agent |

**Формат телефона:** Любой номер вида `79999xxxxxx` (где x — любая цифра) работает с кодами `111111`-`666666`.

### Email авторизация (Клиенты)

| Email | Код | Роль |
|-------|-----|------|
| `client1@test.housler.ru` | `111111` | client |
| `client2@test.housler.ru` | `222222` | client |
| `buyer@test.housler.ru` | `111111` | client |
| `seller@test.housler.ru` | `222222` | client |

**Формат email:** Любой email на домене `@test.housler.ru` работает с кодами `111111`-`666666`.

### Пароль авторизация (Агентства)

Создаются через регистрацию на agent.housler.ru или через seed-скрипт.

### Admin доступ

Для тестирования `/admin/*` нужен пользователь с `role = 'admin'`. Создается через БД:

```sql
UPDATE users SET role = 'admin' WHERE phone = '79999111111';
```

---

## Роли пользователей

### Agent (Агент / Риелтор)

**Вход:** `/realtor` → SMS код

**Функционал:**
- Создание сделок (обычных и bank-split)
- Просмотр своих сделок
- Приглашение со-агентов
- Подтверждение оказания услуги
- Открытие споров
- Экспорт отчётов

**Страницы:**
- `/agent/dashboard` — главная с статистикой
- `/agent/deals` — список сделок
- `/agent/deals/new` — создание обычной сделки
- `/agent/deals/bank-split/new` — создание bank-split сделки
- `/agent/deals/bank-split/[id]` — детали сделки
- `/agent/profile` — профиль

### Client (Клиент)

**Вход:** `/client` → Email код

**Функционал:**
- Просмотр своих сделок
- Подписание договоров (ПЭП)
- Оплата комиссии
- Подтверждение получения услуги
- Открытие споров

**Страницы:**
- `/client/dashboard` — главная
- `/client/deals/[id]` — детали сделки
- `/sign/[token]` — подписание договора
- `/pay/[dealId]` — оплата

### Agency (Агентство)

**Вход:** `/agency` → Email + пароль

**Функционал:**
- Управление агентами
- Просмотр всех сделок агентства
- Финансовая отчётность
- Настройки агентства

**Страницы:**
- `/agency/dashboard` — главная
- `/agency/agents` — список агентов
- `/agency/deals` — сделки агентства
- `/agency/finance` — финансы
- `/agency/settings` — настройки

### Admin (Администратор)

**Вход:** Любой способ + `role = 'admin'` в БД

**Функционал:**
- Глобальная статистика
- Все сделки платформы
- Разрешение споров
- Управление выплатами
- Экспорт отчётов

**Страницы:**
- `/admin/dashboard` — статистика платформы
- `/admin/deals` — все сделки
- `/admin/disputes` — споры
- `/admin/payouts` — выплаты

---

## Сценарии тестирования

### Сценарий 1: Полный цикл Bank-Split сделки

**Участники:**
- Агент 1: `79999111111` / `111111`
- Агент 2 (со-агент): `79999222222` / `222222`
- Клиент: `buyer@test.housler.ru` / `111111`

**Шаги:**

1. **Агент 1 создаёт сделку**
   ```
   URL: /agent/deals/bank-split/new

   Step 1 - Тип сделки:
   - Выбрать: Покупка (sale_buy)

   Step 2 - Объект:
   - Адрес: "Москва, ул. Тестовая, д. 1"
   - Цена: 10 000 000 руб.

   Step 3 - Комиссия:
   - Тип: Процент
   - Процент: 3%
   - Тип оплаты: Без аванса
   - Проверить расчёт: 300 000 руб.
   - Проверить комиссию платформы (4%): 12 000 руб.

   Step 4 - Участники:
   - Клиент: buyer@test.housler.ru
   - Со-агент (опционально): 79999222222
   - Split: 70% / 30%

   Step 5 - Подтверждение:
   - Checkbox: Согласен с комиссией 4%
   - Создать сделку
   ```

2. **Проверить создание сделки**
   ```
   - Статус: draft
   - Проверить split recipients
   - Проверить приглашение со-агенту (если добавлен)
   ```

3. **Со-агент принимает приглашение**
   ```
   URL: /invite/[token] (ссылка из SMS)

   - Войти как 79999222222
   - Проверить детали приглашения
   - Нажать "Принять приглашение"
   - Статус приглашения: accepted
   ```

4. **Агент отправляет на подписание**
   ```
   URL: /agent/deals/bank-split/[id]

   - Нажать "Отправить на подписание"
   - Статус сделки: awaiting_signatures
   - Клиент получает SMS/Email со ссылкой
   ```

5. **Клиент подписывает договор**
   ```
   URL: /sign/[token]

   - Просмотреть информацию о сделке
   - Нажать "Перейти к подписанию"
   - Поставить checkbox: согласие на ПД
   - Поставить checkbox: согласие на ПЭП
   - Нажать "Получить код"
   - Ввести код из SMS: 111111
   - Нажать "Подписать"
   - Статус: Документ подписан
   ```

6. **Агент отправляет ссылку на оплату**
   ```
   URL: /agent/deals/bank-split/[id]

   - Статус: signed (все подписали)
   - Нажать "Отправить ссылку на оплату"
   - Клиент получает SMS со ссылкой
   ```

7. **Клиент оплачивает**
   ```
   URL: /pay/[dealId]

   - Проверить сумму
   - Отсканировать QR или нажать "Перейти к оплате"
   - Оплатить через T-Bank
   - Webhook от T-Bank обновляет статус
   - Статус сделки: hold_period
   ```

8. **Hold period (1 час)**
   ```
   - Деньги на холде
   - Можно открыть спор
   - После истечения hold → payout_ready
   ```

9. **Клиент подтверждает услугу**
   ```
   URL: /client/deals/[id] или /agent/deals/bank-split/[id]

   - Нажать "Подтвердить оказание услуги"
   - Статус: completed (или closed)
   ```

10. **Выплата агентам**
    ```
    - Статус: payout_ready
    - Admin видит в /admin/payouts
    - Admin нажимает "Выплачено"
    - Статус: closed
    ```

**Ожидаемый результат:**
- Сделка закрыта
- Агент 1 получил: 70% от (300 000 - 12 000) = 201 600 руб.
- Агент 2 получил: 30% от (300 000 - 12 000) = 86 400 руб.
- Платформа получила: 12 000 руб.

---

### Сценарий 2: Спор и возврат

**Предусловие:** Сделка в статусе `hold_period` или `payout_ready`

**Шаги:**

1. **Клиент открывает спор**
   ```
   URL: /client/deals/[id]

   - Нажать "Открыть спор"
   - Причина: service_not_provided
   - Описание: "Услуга не была оказана"
   - Запросить возврат: Да
   - Сумма возврата: полная (или частичная)
   - Отправить
   ```

2. **Статус сделки меняется**
   ```
   - Статус сделки: dispute
   - Создан Dispute с status: open
   ```

3. **Admin разрешает спор**
   ```
   URL: /admin/disputes

   - Найти спор
   - Нажать "Разрешить"
   - Выбрать решение:
     - approved: полный возврат
     - partial: частичный возврат
     - rejected: отклонить
   - Добавить комментарий
   - Сохранить
   ```

4. **Результат**
   ```
   Если approved:
   - Статус спора: resolved
   - Статус сделки: refunded
   - Деньги возвращаются клиенту

   Если rejected:
   - Статус спора: rejected
   - Сделка продолжает обработку
   ```

---

### Сценарий 3: Корректировка Split

**Предусловие:** Сделка создана, но ещё не оплачена

**Шаги:**

1. **Агент запрашивает корректировку**
   ```
   URL: /agent/deals/bank-split/[id]

   - Найти секцию "Распределение комиссии"
   - Нажать "Корректировать"
   - Изменить пропорции (например, 60/40 вместо 70/30)
   - Указать причину
   - Отправить запрос
   ```

2. **Со-агент подтверждает**
   ```
   - Со-агент получает уведомление
   - Заходит в сделку
   - Подтверждает или отклоняет корректировку
   ```

3. **Результат**
   ```
   - Split обновлён
   - История изменений сохранена
   ```

---

### Сценарий 4: Отмена сделки

**Предусловие:** Сделка в статусе `draft` или `awaiting_signatures`

**Шаги:**

1. **Агент отменяет сделку**
   ```
   URL: /agent/deals/bank-split/[id]

   - Нажать "Отменить сделку"
   - Указать причину
   - Подтвердить
   ```

2. **Результат**
   ```
   - Статус: cancelled
   - Приглашения отменены
   - Сделка не может быть возобновлена
   ```

---

## API Endpoints

### Авторизация (через agent.housler.ru)

| Method | Endpoint | Описание |
|--------|----------|----------|
| POST | `/api/auth/request-sms` | Запросить SMS код |
| POST | `/api/auth/verify-sms` | Подтвердить SMS код |
| POST | `/api/auth/request-code` | Запросить Email код |
| POST | `/api/auth/verify-code` | Подтвердить Email код |
| POST | `/api/auth/login-agency` | Вход агентства (пароль) |
| GET | `/api/auth/me` | Текущий пользователь |

### Bank-Split сделки

| Method | Endpoint | Описание |
|--------|----------|----------|
| GET | `/api/v1/bank-split` | Список сделок |
| POST | `/api/v1/bank-split` | Создать сделку |
| GET | `/api/v1/bank-split/{id}` | Детали сделки |
| PUT | `/api/v1/bank-split/{id}` | Обновить сделку |
| POST | `/api/v1/bank-split/{id}/submit` | Отправить на подписание |
| POST | `/api/v1/bank-split/{id}/send-payment-link` | Отправить ссылку на оплату |
| GET | `/api/v1/bank-split/{id}/payment-info` | Информация для оплаты |
| POST | `/api/v1/bank-split/{id}/confirm-service` | Подтвердить услугу |
| POST | `/api/v1/bank-split/webhooks/tbank` | Webhook от T-Bank |
| POST | `/api/v1/bank-split/calculate` | Расчёт комиссии |

### Приглашения

| Method | Endpoint | Описание |
|--------|----------|----------|
| GET | `/api/v1/invitations/{token}` | Получить приглашение |
| POST | `/api/v1/invitations/{token}/accept` | Принять приглашение |
| POST | `/api/v1/invitations/{token}/decline` | Отклонить приглашение |

### Споры

| Method | Endpoint | Описание |
|--------|----------|----------|
| GET | `/api/v1/disputes` | Список споров |
| POST | `/api/v1/disputes` | Создать спор |
| GET | `/api/v1/disputes/{id}` | Детали спора |
| POST | `/api/v1/disputes/{id}/resolve` | Разрешить спор (admin) |

### Подписание (ПЭП)

| Method | Endpoint | Описание |
|--------|----------|----------|
| GET | `/api/v1/sign/{token}` | Информация для подписания |
| POST | `/api/v1/sign/{token}/request-otp` | Запросить OTP |
| POST | `/api/v1/sign/{token}/verify` | Подтвердить и подписать |

### Admin

| Method | Endpoint | Описание |
|--------|----------|----------|
| GET | `/api/v1/admin/analytics` | Глобальная аналитика |
| GET | `/api/v1/admin/deals` | Все сделки |
| GET | `/api/v1/admin/disputes` | Все споры |
| GET | `/api/v1/admin/payouts` | Ожидающие выплаты |
| POST | `/api/v1/admin/payouts/{id}/paid` | Отметить выплату |
| GET | `/api/v1/admin/leaderboard` | Топ агентов |
| GET | `/api/v1/admin/export/*` | Экспорт отчётов |

---

## Бизнес-логика Bank-Split

### Статусы сделки

```
draft → awaiting_signatures → signed → payment_pending → hold_period → payout_ready → closed
                                                              │
                                                              ├── dispute
                                                              │       │
                                                              │       ├── resolved → closed/refunded
                                                              │       └── rejected → payout_ready
                                                              │
                                                              └── cancelled
```

| Статус | Описание | Возможные действия |
|--------|----------|-------------------|
| `draft` | Черновик | Редактировать, отправить на подписание, отменить |
| `awaiting_signatures` | Ожидает подписей | Подписать (клиент/агенты), отменить |
| `signed` | Подписано всеми | Отправить ссылку на оплату |
| `payment_pending` | Ожидает оплаты | Оплатить (клиент) |
| `hold_period` | Холд (1 час) | Подтвердить услугу, открыть спор |
| `payout_ready` | Готов к выплате | Выплатить (admin) |
| `closed` | Закрыта | - |
| `dispute` | Спор | Разрешить (admin) |
| `refunded` | Возврат | - |
| `cancelled` | Отменена | - |

### Расчёт комиссии

```
Цена объекта: 10 000 000 руб.
Комиссия агента: 3% = 300 000 руб.
Комиссия платформы: 4% от комиссии агента = 12 000 руб.

К распределению: 300 000 - 12 000 = 288 000 руб.

Если split 70/30:
- Агент 1: 288 000 * 0.7 = 201 600 руб.
- Агент 2: 288 000 * 0.3 = 86 400 руб.
```

### Параметры

| Параметр | Значение | Env переменная |
|----------|----------|----------------|
| Комиссия платформы | 4% | `PLATFORM_FEE_PERCENT` |
| Минимальная сумма сделки | 1 000 руб. | `MIN_DEAL_AMOUNT` |
| Hold period | 1 час | `HOLD_PERIOD_HOURS` |

---

## Интеграции

### T-Bank (Платежи)

**Режимы:**
- Test: `TBANK_TEST_MODE=true` (sandbox API)
- Production: `TBANK_TEST_MODE=false`

**Webhook URL:** `POST /api/v1/bank-split/webhooks/tbank`

**Тестирование webhook:**
```bash
curl -X POST http://localhost:8000/api/v1/bank-split/webhooks/tbank \
  -H "Content-Type: application/json" \
  -d '{
    "TerminalKey": "test",
    "OrderId": "deal-123",
    "Status": "CONFIRMED",
    "Success": true,
    "Amount": 30000000
  }'
```

### SMS.RU

**Режимы:**
- Test: `SMS_TEST_MODE=true` (коды не отправляются, используются тестовые)
- Production: `SMS_TEST_MODE=false`

**Тестовые коды:** `111111` - `666666`

### Email (уведомления)

**Provider:** SMTP / SendGrid / Mailgun

**Типы уведомлений:**
- Приглашение в сделку
- Договор на подписание
- Ссылка на оплату
- Подтверждение оплаты
- Спор открыт/разрешён

---

## Чек-листы

### Чек-лист: Создание Bank-Split сделки

```
[ ] Выбор типа сделки работает
[ ] Валидация адреса (не пустой)
[ ] Валидация цены (> 1000 руб.)
[ ] Расчёт комиссии корректный
[ ] Комиссия платформы 4% отображается
[ ] Email/телефон клиента валидируется
[ ] Телефон со-агента валидируется
[ ] Slider распределения работает (сумма = 100%)
[ ] Checkbox согласия обязательный
[ ] Сделка создаётся в статусе draft
[ ] Split recipients созданы корректно
[ ] Приглашение со-агенту отправлено (если указан)
```

### Чек-лист: Подписание договора (ПЭП)

```
[ ] Страница /sign/[token] открывается
[ ] Информация о сделке корректная
[ ] Кнопка "Просмотреть документ" работает
[ ] Оба checkbox обязательны
[ ] OTP отправляется на телефон
[ ] Неверный код — ошибка
[ ] Верный код — документ подписан
[ ] Повторная отправка кода работает
[ ] После подписания — success screen
[ ] Повторный вход — "уже подписано"
```

### Чек-лист: Оплата

```
[ ] Страница /pay/[dealId] открывается
[ ] Сумма корректная
[ ] QR-код отображается
[ ] Кнопка "Перейти к оплате" работает
[ ] После оплаты webhook обрабатывается
[ ] Статус сделки меняется на hold_period
[ ] Истёкший счёт — "срок оплаты истёк"
[ ] Оплаченный счёт — "оплата получена"
```

### Чек-лист: Споры

```
[ ] Кнопка "Открыть спор" видна в hold_period/payout_ready
[ ] Форма спора: причина, описание, возврат
[ ] Спор создаётся со статусом open
[ ] Статус сделки меняется на dispute
[ ] Admin видит спор в /admin/disputes
[ ] Admin может разрешить спор
[ ] Решение approved — refund
[ ] Решение rejected — возврат к payout_ready
```

### Чек-лист: Admin Panel

```
[ ] /admin/dashboard показывает статистику
[ ] Графики и числа корректные
[ ] /admin/deals показывает все сделки
[ ] Фильтрация по статусу работает
[ ] /admin/disputes показывает споры
[ ] Разрешение спора работает
[ ] /admin/payouts показывает выплаты
[ ] "Выплачено" меняет статус
[ ] Экспорт CSV/Excel работает
```

---

## Запуск тестов

### Backend (pytest)

```bash
cd backend
pytest -v
pytest -v tests/services/bank_split/
pytest -v tests/services/inn/
```

### Frontend (TypeScript)

```bash
cd frontend
npm run build  # или npx tsc --noEmit
```

### E2E (если настроен)

```bash
npm run test:e2e
```

---

## Troubleshooting

### "401 Unauthorized"

- Проверить JWT токен в localStorage
- Проверить что JWT_SECRET совпадает с agent.housler.ru
- Попробовать перелогиниться

### "CORS error"

- Проверить CORS настройки в backend
- Проверить что frontend вызывает правильный API URL

### "Webhook не обрабатывается"

- Проверить логи backend
- Проверить что URL доступен извне
- Проверить формат данных от T-Bank

### "SMS не приходит"

- Проверить SMS_TEST_MODE (должен быть true для тестов)
- Проверить SMS_RU_API_ID
- Для тестов использовать коды 111111-666666

---

## Контакты и ресурсы

- **Документация:** `/docs/`
- **Design System:** `/docs/DESIGN-SYSTEM.md`
- **Auth:** `/docs/UNIFIED_AUTH.md`
- **Bank-Split:** `/docs/features/bank-split/`
- **TPM:** `/team/TPM_PROMPT.md`
