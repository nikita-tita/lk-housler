# –¢–ó: –ê–≥–µ–Ω—Ç—Å–∫–∏–µ —Ç–µ–≥–∏ –≤ —Ñ–∏—Å–∫–∞–ª—å–Ω—ã—Ö —á–µ–∫–∞—Ö (54-–§–ó)

**–î–∞—Ç–∞:** 2026-01-26
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –ö—Ä–∏—Ç–∏—á–Ω—ã–π
**–°—Ç–∞—Ç—É—Å:** ‚úÖ DONE

---

## 1. –ü—Ä–æ–±–ª–µ–º–∞

### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ **–∞–≥–µ–Ω—Ç—Å–∫–æ–π —Å—Ö–µ–º–µ** (103-–§–ó –Ω–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è, —Ç.–∫. –Ω–µ—Ç –Ω–∞–ª–∏—á–Ω—ã—Ö).
–ß–µ–∫ –∫–ª–∏–µ–Ω—Ç—É –≤—ã–¥–∞—ë—Ç **–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞**, –Ω–æ –±–µ–∑ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –∞–≥–µ–Ω—Ç—Å–∫–∏—Ö —Ç–µ–≥–æ–≤.

### –ß—Ç–æ –Ω–µ –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≤ T-Bank Checks API

| –¢–µ–≥ –§–§–î | –ù–∞–∑–≤–∞–Ω–∏–µ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|---------|----------|------------|
| **1057** | –ü—Ä–∏–∑–Ω–∞–∫ –∞–≥–µ–Ω—Ç–∞ | –£–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ –ø—Ä–æ–¥–∞–≤–µ—Ü –¥–µ–π—Å—Ç–≤—É–µ—Ç –∫–∞–∫ –∞–≥–µ–Ω—Ç |
| **1226** | –ò–ù–ù –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ | –ò–ù–ù —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è —É—Å–ª—É–≥–∏ |
| **1225** | –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ | –ù–∞–∑–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏/–§–ò–û –°–ú–ó |
| **1171** | –¢–µ–ª–µ—Ñ–æ–Ω –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ | –ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) |

### –ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è
- –§–ù–° –≤–∏–¥–∏—Ç **–≤—Å—é –≤—ã—Ä—É—á–∫—É –∫–∞–∫ –≤–∞—à—É**, –∞ –Ω–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤
- –ü–æ—Å—Ç–∞–≤—â–∏–∫–∏ (–û–û–û, –ò–ü, –°–ú–ó) –Ω–µ –º–æ–≥—É—Ç —É—á–µ—Å—Ç—å –¥–æ—Ö–æ–¥ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- –†–∏—Å–∫ –¥–æ–Ω–∞—á–∏—Å–ª–µ–Ω–∏–π –∏ —à—Ç—Ä–∞—Ñ–æ–≤ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ

---

## 2. –¢—Ä–µ–±—É–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç —á–µ–∫–∞

### 2.1. –ü—Ä–æ—Å—Ç–æ–π —Å–ª—É—á–∞–π (–æ–¥–∏–Ω –ø–æ—Å—Ç–∞–≤—â–∏–∫)

```json
{
  "TerminalKey": "...",
  "Amount": 45000000,
  "OrderId": "deal-uuid-123",
  "Receipt": {
    "Email": "client@example.com",
    "Taxation": "usn_income",
    "Items": [
      {
        "Name": "–£—Å–ª—É–≥–∏ –∞–≥–µ–Ω—Ç–∞ –ø–æ —Å–¥–µ–ª–∫–µ: —É–ª. –õ–µ–Ω–∏–Ω–∞, 10",
        "Quantity": 1,
        "Price": 45000000,
        "Amount": 45000000,
        "PaymentMethod": "full_payment",
        "PaymentObject": "agent_commission",
        "Tax": "none",
        "AgentData": {
          "AgentSign": "agent"
        },
        "SupplierInfo": {
          "Inn": "772012345678",
          "Name": "–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á",
          "Phones": ["+79991234567"]
        }
      }
    ]
  }
}
```

### 2.2. –ú—É–ª—å—Ç–∏-—Å–ø–ª–∏—Ç (–Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ –≤ –æ–¥–Ω–æ–º —á–µ–∫–µ)

```json
{
  "TerminalKey": "...",
  "Amount": 45000000,
  "OrderId": "deal-uuid-123",
  "Receipt": {
    "Email": "client@example.com",
    "Taxation": "usn_income",
    "Items": [
      {
        "Name": "–£—Å–ª—É–≥–∏ –∞–≥–µ–Ω—Ç—Å—Ç–≤–∞ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏",
        "Quantity": 1,
        "Price": 27000000,
        "Amount": 27000000,
        "PaymentMethod": "full_payment",
        "PaymentObject": "agent_commission",
        "Tax": "vat20",
        "AgentData": {
          "AgentSign": "agent"
        },
        "SupplierInfo": {
          "Inn": "7707123456",
          "Name": "–û–û–û –ê–ù –ü—Ä–∏–º–µ—Ä",
          "Phones": ["+74951234567"]
        }
      },
      {
        "Name": "–£—Å–ª—É–≥–∏ —Ä–∏–µ–ª—Ç–æ—Ä–∞",
        "Quantity": 1,
        "Price": 18000000,
        "Amount": 18000000,
        "PaymentMethod": "full_payment",
        "PaymentObject": "agent_commission",
        "Tax": "none",
        "AgentData": {
          "AgentSign": "agent"
        },
        "SupplierInfo": {
          "Inn": "772012345678",
          "Name": "–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á",
          "Phones": ["+79991234567"]
        }
      }
    ]
  }
}
```

---

## 3. –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ

### 3.1. –ù–æ–≤—ã–µ dataclass –≤ `tbank_checks.py`

```python
# backend/app/services/fiscalization/tbank_checks.py

from dataclasses import dataclass, field
from typing import List, Optional


class AgentSign(str, Enum):
    """–ü—Ä–∏–∑–Ω–∞–∫ –∞–≥–µ–Ω—Ç–∞ (—Ç–µ–≥ 1057)"""
    BANK_PAYING_AGENT = "bank_paying_agent"       # –ë–∞–Ω–∫–æ–≤—Å–∫–∏–π –ø–ª–∞—Ç–µ–∂–Ω—ã–π –∞–≥–µ–Ω—Ç
    BANK_PAYING_SUBAGENT = "bank_paying_subagent" # –ë–∞–Ω–∫–æ–≤—Å–∫–∏–π –ø–ª–∞—Ç–µ–∂–Ω—ã–π —Å—É–±–∞–≥–µ–Ω—Ç
    PAYING_AGENT = "paying_agent"                 # –ü–ª–∞—Ç–µ–∂–Ω—ã–π –∞–≥–µ–Ω—Ç
    PAYING_SUBAGENT = "paying_subagent"           # –ü–ª–∞—Ç–µ–∂–Ω—ã–π —Å—É–±–∞–≥–µ–Ω—Ç
    ATTORNEY = "attorney"                         # –ü–æ–≤–µ—Ä–µ–Ω–Ω—ã–π
    COMMISSION_AGENT = "commission_agent"         # –ö–æ–º–∏—Å—Å–∏–æ–Ω–µ—Ä
    AGENT = "agent"                               # –ê–≥–µ–Ω—Ç (–Ω–∞—à —Å–ª—É—á–∞–π)


@dataclass
class AgentData:
    """–î–∞–Ω–Ω—ã–µ –∞–≥–µ–Ω—Ç–∞ –¥–ª—è —á–µ–∫–∞ (—Ç–µ–≥–∏ 1057, 1073, 1074, 1075)"""
    agent_sign: AgentSign  # –¢–µ–≥ 1057 - –ø—Ä–∏–∑–Ω–∞–∫ –∞–≥–µ–Ω—Ç–∞
    operation: Optional[str] = None  # –¢–µ–≥ 1044 - –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (–¥–ª—è –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö –∞–≥–µ–Ω—Ç–æ–≤)
    phones: Optional[List[str]] = None  # –¢–µ–≥ 1073 - —Ç–µ–ª–µ—Ñ–æ–Ω—ã –ø–ª–∞—Ç–µ–∂–Ω–æ–≥–æ –∞–≥–µ–Ω—Ç–∞
    receiver_phones: Optional[List[str]] = None  # –¢–µ–≥ 1074 - —Ç–µ–ª–µ—Ñ–æ–Ω—ã –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –ø–µ—Ä–µ–≤–æ–¥–∞
    transfer_phones: Optional[List[str]] = None  # –¢–µ–≥ 1075 - —Ç–µ–ª–µ—Ñ–æ–Ω—ã –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –ø—Ä–∏–µ–º–∞ –ø–ª–∞—Ç–µ–∂–∞


@dataclass
class SupplierInfo:
    """–î–∞–Ω–Ω—ã–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ –¥–ª—è —á–µ–∫–∞ (—Ç–µ–≥–∏ 1225, 1226, 1171)"""
    inn: str  # –¢–µ–≥ 1226 - –ò–ù–ù –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
    name: Optional[str] = None  # –¢–µ–≥ 1225 - –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞
    phones: Optional[List[str]] = None  # –¢–µ–≥ 1171 - —Ç–µ–ª–µ—Ñ–æ–Ω—ã –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞


@dataclass
class ReceiptItem:
    """Item in the receipt - –û–ë–ù–û–í–õ–Å–ù–ù–ê–Ø –í–ï–†–°–ò–Ø"""
    name: str
    quantity: Decimal
    price: int  # kopeks
    amount: int  # kopeks
    payment_method: PaymentMethod = PaymentMethod.FULL_PAYMENT
    payment_object: PaymentObject = PaymentObject.SERVICE
    vat: VatType = VatType.NONE

    # NEW: –ê–≥–µ–Ω—Ç—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ
    agent_data: Optional[AgentData] = None
    supplier_info: Optional[SupplierInfo] = None
```

### 3.2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç–æ–¥–∞ `create_receipt` –≤ `TBankChecksClient`

```python
# backend/app/services/fiscalization/tbank_checks.py

async def create_receipt(self, request: CreateReceiptRequest) -> ReceiptResponse:
    """Create a fiscal receipt with agent tags support."""

    if self.mock_mode:
        return await self._mock_create_receipt(request)

    items = []
    total_amount = 0

    for item in request.items:
        item_dict = {
            "Name": item.name[:128],
            "Quantity": float(item.quantity),
            "Price": item.price,
            "Amount": item.amount,
            "PaymentMethod": item.payment_method.value,
            "PaymentObject": item.payment_object.value,
            "Tax": item.vat.value,
        }

        # NEW: –î–æ–±–∞–≤–ª—è–µ–º –∞–≥–µ–Ω—Ç—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ (—Ç–µ–≥ 1057)
        if item.agent_data:
            item_dict["AgentData"] = {
                "AgentSign": item.agent_data.agent_sign.value,
            }
            if item.agent_data.operation:
                item_dict["AgentData"]["OperatorName"] = item.agent_data.operation
            if item.agent_data.phones:
                item_dict["AgentData"]["Phones"] = item.agent_data.phones

        # NEW: –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ (—Ç–µ–≥–∏ 1225, 1226, 1171)
        if item.supplier_info:
            item_dict["SupplierInfo"] = {
                "Inn": item.supplier_info.inn,
            }
            if item.supplier_info.name:
                item_dict["SupplierInfo"]["Name"] = item.supplier_info.name
            if item.supplier_info.phones:
                item_dict["SupplierInfo"]["Phones"] = item.supplier_info.phones

        items.append(item_dict)
        total_amount += item.amount

    # ... rest of the method
```

### 3.3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ `FiscalReceiptService._send_receipt_to_tbank`

```python
# backend/app/services/fiscalization/fiscal_receipt_service.py

async def _send_receipt_to_tbank(
    self,
    fiscal_receipt: FiscalReceipt,
    deal: Deal,
) -> None:
    """Send receipt to T-Bank with agent tags for each recipient."""

    # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π —Å–ø–ª–∏—Ç–∞
    recipients = await self._get_deal_split_recipients(deal.id)

    items = []

    for recipient in recipients:
        # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º platform_fee - —ç—Ç–æ –Ω–∞—à–∞ –∫–æ–º–∏—Å—Å–∏—è
        if recipient.role == RecipientRole.PLATFORM_FEE.value:
            continue

        # –§–æ—Ä–º–∏—Ä—É–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏
        if recipient.role == RecipientRole.AGENCY.value:
            item_name = f"–£—Å–ª—É–≥–∏ –∞–≥–µ–Ω—Ç—Å—Ç–≤–∞ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏"
        elif recipient.role == RecipientRole.AGENT.value:
            item_name = f"–£—Å–ª—É–≥–∏ —Ä–∏–µ–ª—Ç–æ—Ä–∞"
        else:
            item_name = f"–£—Å–ª—É–≥–∏ –ø–æ —Å–¥–µ–ª–∫–µ"

        # –î–æ–±–∞–≤–ª—è–µ–º –∞–¥—Ä–µ—Å –µ—Å–ª–∏ –µ—Å—Ç—å –º–µ—Å—Ç–æ
        if deal.property_address and len(item_name) + len(deal.property_address) < 120:
            item_name += f": {deal.property_address}"

        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ù–î–° –ø–æ —Ç–∏–ø—É —é—Ä–ª–∏—Ü–∞
        vat = VatType.NONE  # –°–ú–ó –±–µ–∑ –ù–î–°
        if recipient.legal_type == LegalType.OOO.value:
            vat = VatType.VAT20  # –û–û–û –æ–±—ã—á–Ω–æ —Å –ù–î–°
        elif recipient.legal_type == LegalType.IP.value:
            # –ò–ü –º–æ–∂–µ—Ç –±—ã—Ç—å —Å –ù–î–° –∏–ª–∏ –±–µ–∑ - –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å–∏—Å—Ç–µ–º—ã –Ω–∞–ª–æ–≥–æ–æ–±–ª–æ–∂–µ–Ω–∏—è
            # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –£–°–ù –±–µ–∑ –ù–î–°
            vat = VatType.NONE

        # –§–æ—Ä–º–∏—Ä—É–µ–º –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞
        supplier_name = await self._get_supplier_name(recipient)

        receipt_item = ReceiptItem(
            name=item_name[:128],
            quantity=Decimal("1"),
            price=int(recipient.calculated_amount * 100),  # –≤ –∫–æ–ø–µ–π–∫–∞—Ö
            amount=int(recipient.calculated_amount * 100),
            payment_method=PaymentMethod.FULL_PAYMENT,
            payment_object=PaymentObject.AGENT_COMMISSION,
            vat=vat,
            agent_data=AgentData(
                agent_sign=AgentSign.AGENT,
            ),
            supplier_info=SupplierInfo(
                inn=recipient.inn,
                name=supplier_name,
                phones=await self._get_supplier_phones(recipient),
            ),
        )

        items.append(receipt_item)

    # ... create and send request
```

### 3.4. –•–µ–ª–ø–µ—Ä-–º–µ—Ç–æ–¥—ã –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞

```python
# backend/app/services/fiscalization/fiscal_receipt_service.py

async def _get_deal_split_recipients(self, deal_id: UUID) -> List[DealSplitRecipient]:
    """Get all split recipients for a deal."""
    stmt = select(DealSplitRecipient).where(
        DealSplitRecipient.deal_id == deal_id
    )
    result = await self.db.execute(stmt)
    return list(result.scalars().all())


async def _get_supplier_name(self, recipient: DealSplitRecipient) -> Optional[str]:
    """Get supplier name for receipt."""
    if recipient.organization_id:
        # –î–ª—è –∞–≥–µ–Ω—Ç—Å—Ç–≤–∞ - –Ω–∞–∑–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
        stmt = select(Organization).where(Organization.id == recipient.organization_id)
        result = await self.db.execute(stmt)
        org = result.scalar_one_or_none()
        if org:
            return org.legal_name

    if recipient.user_id:
        # –î–ª—è –∞–≥–µ–Ω—Ç–∞ - –§–ò–û
        stmt = select(User).where(User.id == recipient.user_id)
        result = await self.db.execute(stmt)
        user = result.scalar_one_or_none()
        if user:
            return f"{user.last_name} {user.first_name} {user.middle_name or ''}".strip()

    return None


async def _get_supplier_phones(self, recipient: DealSplitRecipient) -> Optional[List[str]]:
    """Get supplier phone numbers for receipt."""
    phones = []

    if recipient.user_id:
        stmt = select(User).where(User.id == recipient.user_id)
        result = await self.db.execute(stmt)
        user = result.scalar_one_or_none()
        if user and user.phone:
            phones.append(user.phone)

    if recipient.organization_id:
        stmt = select(Organization).where(Organization.id == recipient.organization_id)
        result = await self.db.execute(stmt)
        org = result.scalar_one_or_none()
        if org and org.phone:
            phones.append(org.phone)

    return phones if phones else None
```

---

## 4. –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

### 4.1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ –ø–æ–ª–µ–π –≤ `DealSplitRecipient`

–£–∂–µ –µ—Å—Ç—å:
- ‚úÖ `inn` - –ò–ù–ù –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞
- ‚úÖ `kpp` - –ö–ü–ü (–¥–ª—è –û–û–û)
- ‚úÖ `legal_type` - —Ç–∏–ø —é—Ä–ª–∏—Ü–∞ (ip/ooo/se)

–í–æ–∑–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:
```python
# backend/app/models/bank_split.py

class DealSplitRecipient(BaseModel):
    # ... existing fields ...

    # NEW: –î–ª—è —Ñ–∏—Å–∫–∞–ª–∏–∑–∞—Ü–∏–∏
    supplier_name = Column(String(255), nullable=True)  # –ö—ç—à–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ
    supplier_phone = Column(String(20), nullable=True)  # –ö—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω
```

### 4.2. –ú–∏–≥—Ä–∞—Ü–∏—è

```python
# backend/alembic/versions/xxx_add_supplier_cache_fields.py

def upgrade():
    op.add_column('deal_split_recipients',
        sa.Column('supplier_name', sa.String(255), nullable=True))
    op.add_column('deal_split_recipients',
        sa.Column('supplier_phone', sa.String(20), nullable=True))

def downgrade():
    op.drop_column('deal_split_recipients', 'supplier_name')
    op.drop_column('deal_split_recipients', 'supplier_phone')
```

---

## 5. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### 5.1. –ù–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ `config.py`

```python
# backend/app/core/config.py

class Settings(BaseSettings):
    # ... existing settings ...

    # Fiscalization - Agent Tags
    FISCALIZATION_AGENT_SIGN: str = "agent"  # –ü—Ä–∏–∑–Ω–∞–∫ –∞–≥–µ–Ω—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    FISCALIZATION_PLATFORM_INN: str = ""  # –ò–ù–ù –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã (–¥–ª—è –∫–æ–º–∏—Å—Å–∏–∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã)
    FISCALIZATION_PLATFORM_NAME: str = "–û–û–û –•–∞—É—Å–ª–µ—Ä"  # –ù–∞–∑–≤–∞–Ω–∏–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
```

---

## 6. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 6.1. Unit-—Ç–µ—Å—Ç—ã

```python
# backend/tests/services/test_fiscal_receipt_service.py

import pytest
from decimal import Decimal

from app.services.fiscalization.tbank_checks import (
    ReceiptItem, AgentData, SupplierInfo, AgentSign,
    PaymentMethod, PaymentObject, VatType
)


class TestReceiptItemWithAgentTags:
    """Test receipt items with agent tags."""

    def test_receipt_item_with_supplier_info(self):
        """Test that ReceiptItem correctly includes SupplierInfo."""
        item = ReceiptItem(
            name="–£—Å–ª—É–≥–∏ —Ä–∏–µ–ª—Ç–æ—Ä–∞",
            quantity=Decimal("1"),
            price=45000000,
            amount=45000000,
            agent_data=AgentData(agent_sign=AgentSign.AGENT),
            supplier_info=SupplierInfo(
                inn="772012345678",
                name="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á",
                phones=["+79991234567"],
            ),
        )

        assert item.agent_data.agent_sign == AgentSign.AGENT
        assert item.supplier_info.inn == "772012345678"
        assert item.supplier_info.name == "–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á"

    def test_receipt_item_ooo_with_vat(self):
        """Test that OOO suppliers have VAT20."""
        item = ReceiptItem(
            name="–£—Å–ª—É–≥–∏ –∞–≥–µ–Ω—Ç—Å—Ç–≤–∞",
            quantity=Decimal("1"),
            price=27000000,
            amount=27000000,
            vat=VatType.VAT20,
            agent_data=AgentData(agent_sign=AgentSign.AGENT),
            supplier_info=SupplierInfo(
                inn="7707123456",
                name="–û–û–û –ê–ù –ü—Ä–∏–º–µ—Ä",
            ),
        )

        assert item.vat == VatType.VAT20

    def test_receipt_item_se_without_vat(self):
        """Test that self-employed have no VAT."""
        item = ReceiptItem(
            name="–£—Å–ª—É–≥–∏ —Ä–∏–µ–ª—Ç–æ—Ä–∞",
            quantity=Decimal("1"),
            price=18000000,
            amount=18000000,
            vat=VatType.NONE,
            agent_data=AgentData(agent_sign=AgentSign.AGENT),
            supplier_info=SupplierInfo(
                inn="772012345678",
                name="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á",
            ),
        )

        assert item.vat == VatType.NONE


class TestTBankChecksClientAgentTags:
    """Test T-Bank Checks client with agent tags."""

    @pytest.mark.asyncio
    async def test_create_receipt_with_agent_tags(self, mock_tbank_client):
        """Test that receipt request includes agent tags."""
        request = CreateReceiptRequest(
            receipt_type=ReceiptType.INCOME,
            items=[
                ReceiptItem(
                    name="Test service",
                    quantity=Decimal("1"),
                    price=10000,
                    amount=10000,
                    agent_data=AgentData(agent_sign=AgentSign.AGENT),
                    supplier_info=SupplierInfo(inn="123456789012"),
                ),
            ],
            client=ReceiptClient(email="test@example.com"),
        )

        response = await mock_tbank_client.create_receipt(request)

        # Verify mock was called with correct payload
        # ... assertions
```

### 6.2. Integration-—Ç–µ—Å—Ç—ã

```python
# backend/tests/integration/test_fiscalization_flow.py

@pytest.mark.asyncio
async def test_full_fiscalization_flow_with_multi_split(
    db: AsyncSession,
    deal_with_multi_split: Deal,
):
    """Test full fiscalization flow with multiple recipients."""
    service = FiscalReceiptService(db)

    # Create receipt
    receipt = await service.create_receipt_for_deal(deal_with_multi_split)

    assert receipt is not None
    assert receipt.status == FiscalReceiptStatus.PENDING.value

    # Verify meta contains all recipients
    assert "recipients" in receipt.meta
    assert len(receipt.meta["recipients"]) == 2  # agency + agent

    # Verify each recipient has INN
    for r in receipt.meta["recipients"]:
        assert "inn" in r
        assert "name" in r
```

---

## 7. –ß–µ–∫–ª–∏—Å—Ç –≤–Ω–µ–¥—Ä–µ–Ω–∏—è

### –≠—Ç–∞–ø 1: –°—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö
- [ ] –î–æ–±–∞–≤–∏—Ç—å `AgentSign` enum
- [ ] –î–æ–±–∞–≤–∏—Ç—å `AgentData` dataclass
- [ ] –î–æ–±–∞–≤–∏—Ç—å `SupplierInfo` dataclass
- [ ] –û–±–Ω–æ–≤–∏—Ç—å `ReceiptItem` —Å –Ω–æ–≤—ã–º–∏ –ø–æ–ª—è–º–∏
- [ ] –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î (–µ—Å–ª–∏ –Ω—É–∂–Ω—ã –∫—ç—à-–ø–æ–ª—è)

### –≠—Ç–∞–ø 2: –°–µ—Ä–≤–∏—Å—ã
- [ ] –û–±–Ω–æ–≤–∏—Ç—å `TBankChecksClient.create_receipt()`
- [ ] –û–±–Ω–æ–≤–∏—Ç—å `FiscalReceiptService._send_receipt_to_tbank()`
- [ ] –î–æ–±–∞–≤–∏—Ç—å —Ö–µ–ª–ø–µ—Ä—ã `_get_supplier_name`, `_get_supplier_phones`
- [ ] –î–æ–±–∞–≤–∏—Ç—å —Ö–µ–ª–ø–µ—Ä `_get_deal_split_recipients`

### –≠—Ç–∞–ø 3: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] Unit-—Ç–µ—Å—Ç—ã –¥–ª—è –Ω–æ–≤—ã—Ö dataclass
- [ ] Unit-—Ç–µ—Å—Ç—ã –¥–ª—è –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤
- [ ] Integration-—Ç–µ—Å—Ç –ø–æ–ª–Ω–æ–≥–æ —Ñ–ª–æ—É
- [ ] Sandbox —Ç–µ—Å—Ç —Å T-Bank (—Ä–µ–∞–ª—å–Ω—ã–π API)

### –≠—Ç–∞–ø 4: Production
- [ ] –í—ã–∫–ª—é—á–∏—Ç—å `TBANK_CHECKS_MOCK_MODE`
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å credentials production
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—à–∏–±–æ–∫ —Ñ–∏—Å–∫–∞–ª–∏–∑–∞—Ü–∏–∏
- [ ] –ê–ª–µ—Ä—Ç—ã –Ω–∞ failed receipts

---

## 8. –°—Å—ã–ª–∫–∏

- [T-Bank Checks API Docs](https://www.tbank.ru/kassa/dev/checks/)
- [–§–§–î 1.2 –¢–µ–≥–∏](https://www.nalog.gov.ru/rn77/related_activities/registries/fiscaldocuments/)
- [54-–§–ó](http://www.consultant.ru/document/cons_doc_LAW_42359/)

---

## 9. –í–æ–ø—Ä–æ—Å—ã –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è

1. **–°–∏—Å—Ç–µ–º–∞ –Ω–∞–ª–æ–≥–æ–æ–±–ª–æ–∂–µ–Ω–∏—è –ò–ü**: –ù—É–∂–Ω–æ –ª–∏ —Ö—Ä–∞–Ω–∏—Ç—å tax_system –≤ PaymentProfile?
   - –ï—Å–ª–∏ –ò–ü –Ω–∞ –û–°–ù–û ‚Üí –ù–î–° 20%
   - –ï—Å–ª–∏ –ò–ü –Ω–∞ –£–°–ù ‚Üí –±–µ–∑ –ù–î–°

2. **–¢–µ–ª–µ—Ñ–æ–Ω—ã –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤**: –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã –∏–ª–∏ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã –≤ —á–µ–∫–µ?
   - –ü–æ –§–§–î 1.2 —Ç–µ–≥ 1171 –æ–ø—Ü–∏–æ–Ω–∞–ª–µ–Ω

3. **–ö–æ–º–∏—Å—Å–∏—è –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã**: –í–∫–ª—é—á–∞—Ç—å –≤ —á–µ–∫ –∏–ª–∏ –Ω–µ—Ç?
   - –ï—Å–ª–∏ –¥–∞ ‚Üí –Ω—É–∂–µ–Ω –æ—Ç–¥–µ–ª—å–Ω—ã–π item —Å –ò–ù–ù –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
   - –ï—Å–ª–∏ –Ω–µ—Ç ‚Üí —Ç–æ–ª—å–∫–æ —Å—É–º–º—ã –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤

4. **–ö–ü–ü –¥–ª—è –û–û–û**: –ù—É–∂–µ–Ω –ª–∏ –≤ SupplierInfo?
   - –í —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–º T-Bank API –Ω–µ—Ç –ø–æ–ª—è –¥–ª—è –ö–ü–ü –≤ SupplierInfo
