# Техническое задание: Модуль управления шаблонами договоров

**Версия:** 2.0
**Дата:** 24.12.2024
**Статус:** На согласовании

---

## 1. Общее описание

Модуль управления шаблонами договоров для оказания риелторских услуг. Обеспечивает генерацию юридически корректных документов с электронной подписью.

### 1.1 Нормативная база

| Документ | Применение |
|----------|------------|
| ГК РФ, глава 39 (ст. 779-783) | Возмездное оказание услуг |
| ГК РФ, глава 49 (ст. 971-979) | Поручение (для агентских договоров) |
| ГК РФ, глава 52 (ст. 1005-1011) | Агентирование |
| 63-ФЗ "Об электронной подписи" | Использование ПЭП |
| 152-ФЗ "О персональных данных" | Обработка ПДн клиентов |
| Закон о защите прав потребителей | Права физлиц-клиентов |
| 115-ФЗ "О противодействии легализации доходов" | AML для крупных сделок |

---

## 2. Типы документов

### 2.1 Основные договоры

| Код | Название | Описание | Стороны |
|-----|----------|----------|---------|
| `secondary_buy` | Договор на подбор (покупка) | Клиент покупает вторичку | Клиент ↔ Агент/Агентство |
| `secondary_sell` | Договор на продажу | Клиент продает вторичку | Клиент ↔ Агент/Агентство |
| `newbuild_booking` | Договор на бронирование | Бронирование в новостройке | Клиент ↔ Агент/Агентство |
| `rental_search` | Договор на поиск аренды | Поиск квартиры в аренду | Клиент ↔ Агент/Агентство |
| `rental_landlord` | Договор на сдачу в аренду | Поиск арендаторов | Собственник ↔ Агент/Агентство |

### 2.2 Закрывающие документы

| Код | Название | Описание |
|-----|----------|----------|
| `act` | Акт оказанных услуг | Подтверждение выполнения услуг |
| `act_partial` | Акт частичного выполнения | При поэтапной оплате |
| `reconciliation_act` | Акт сверки взаиморасчетов | При сложных расчетах |

### 2.3 Дополнительные документы

| Код | Название | Описание |
|-----|----------|----------|
| `additional_agreement` | Дополнительное соглашение | Изменение условий договора |
| `termination_agreement` | Соглашение о расторжении | Прекращение договора |
| `pd_consent` | Согласие на обработку ПДн | Отдельный документ по 152-ФЗ |
| `pep_consent` | Согласие на ПЭП | Соглашение об электронном документообороте |
| `power_of_attorney` | Доверенность | Для представительства |

---

## 3. Обязательные разделы договоров

### 3.1 Юридические требования к договору оказания услуг

По ГК РФ ст. 779-783 договор ДОЛЖЕН содержать:

| Раздел | Требование | Статья ГК |
|--------|------------|-----------|
| Предмет договора | Конкретный перечень услуг | ст. 779 |
| Цена | Сумма и порядок оплаты | ст. 781 |
| Сроки | Срок оказания услуг | ст. 708 (по аналогии) |
| Качество | Требования к результату | ст. 721 (по аналогии) |

### 3.2 Рекомендуемые разделы (снижение рисков)

| Раздел | Зачем нужен |
|--------|-------------|
| Форс-мажор | Освобождение от ответственности при ЧС |
| Ограничение ответственности | Лимит возмещения убытков |
| Конфиденциальность | Защита информации о сделке |
| Разрешение споров | Досудебный порядок, подсудность |
| Срок хранения данных | Требование 152-ФЗ |
| Право на отказ | Для потребителей (14 дней) |
| Эксклюзивность | Запрет работы с другими агентами |
| Антикоррупционная оговорка | Для работы с юрлицами |

### 3.3 Структура типового договора

```
1. ПРЕАМБУЛА
   - Дата и место заключения
   - Наименование сторон с реквизитами
   - Основание полномочий (для ЮЛ)

2. ПРЕДМЕТ ДОГОВОРА
   - Описание услуг (исчерпывающий перечень)
   - Характеристики объекта недвижимости
   - Ожидаемый результат

3. ПРАВА И ОБЯЗАННОСТИ СТОРОН
   3.1. Обязанности Исполнителя
   3.2. Обязанности Заказчика
   3.3. Права Исполнителя
   3.4. Права Заказчика

4. СТОИМОСТЬ УСЛУГ И ПОРЯДОК РАСЧЕТОВ
   - Общая сумма вознаграждения (цифрами и прописью)
   - График платежей с условиями
   - Способ оплаты (СБП, безнал)
   - Валюта расчетов

5. СРОКИ ОКАЗАНИЯ УСЛУГ
   - Общий срок договора
   - Промежуточные сроки (этапы)
   - Порядок продления

6. СДАЧА-ПРИЕМКА УСЛУГ
   - Порядок уведомления о выполнении
   - Сроки подписания актов
   - Последствия уклонения от подписания

7. ОТВЕТСТВЕННОСТЬ СТОРОН
   - Неустойка за просрочку оплаты (0.1% в день)
   - Ограничение ответственности (не более суммы договора)
   - Основания освобождения

8. ФОРС-МАЖОР
   - Перечень обстоятельств
   - Порядок уведомления
   - Последствия

9. КОНФИДЕНЦИАЛЬНОСТЬ
   - Что является конфиденциальным
   - Срок сохранения (3 года после окончания)
   - Санкции за разглашение

10. ПОРЯДОК РАСТОРЖЕНИЯ
    - По соглашению сторон
    - По инициативе Заказчика (ст. 782 ГК)
    - По инициативе Исполнителя
    - Возврат средств при расторжении

11. РАЗРЕШЕНИЕ СПОРОВ
    - Претензионный порядок (30 дней)
    - Подсудность (по месту нахождения ответчика)

12. ЭЛЕКТРОННЫЙ ДОКУМЕНТООБОРОТ (ПЭП)
    - Ссылка на 63-ФЗ
    - Описание ключа ПЭП (SMS-код)
    - Равнозначность бумажному документу

13. ОБРАБОТКА ПЕРСОНАЛЬНЫХ ДАННЫХ
    - Цели обработки
    - Перечень данных
    - Срок хранения
    - Права субъекта ПДн

14. ЗАКЛЮЧИТЕЛЬНЫЕ ПОЛОЖЕНИЯ
    - Количество экземпляров
    - Приложения
    - Порядок внесения изменений

15. РЕКВИЗИТЫ И ПОДПИСИ СТОРОН
    - Для ЮЛ: наименование, ИНН, КПП, ОГРН, адрес, банковские реквизиты
    - Для ФЛ: ФИО, паспорт, адрес, телефон
    - Подписи / ПЭП

ПРИЛОЖЕНИЯ:
    - Согласие на обработку ПДн
    - Соглашение о ПЭП
    - Описание объекта (при наличии)
```

---

## 4. Плейсхолдеры

### 4.1 Данные исполнителя

| Плейсхолдер | Описание | Источник |
|-------------|----------|----------|
| `{{executor_name}}` | Наименование | settings.COMPANY_NAME или User/Org |
| `{{executor_inn}}` | ИНН | settings.COMPANY_INN |
| `{{executor_kpp}}` | КПП (для ЮЛ) | settings.COMPANY_KPP |
| `{{executor_ogrn}}` | ОГРН/ОГРНИП | settings.COMPANY_OGRN |
| `{{executor_address}}` | Юридический адрес | settings.COMPANY_ADDRESS |
| `{{executor_phone}}` | Телефон | settings.COMPANY_PHONE |
| `{{executor_email}}` | Email | settings.COMPANY_EMAIL |
| `{{executor_bank_name}}` | Название банка | из настроек |
| `{{executor_bank_bik}}` | БИК банка | из настроек |
| `{{executor_bank_account}}` | Расчетный счет | из настроек |
| `{{executor_bank_corr}}` | Корр. счет | из настроек |

### 4.2 Данные клиента

| Плейсхолдер | Описание | Источник |
|-------------|----------|----------|
| `{{client_name}}` | ФИО полностью | Deal.client_name |
| `{{client_name_short}}` | Фамилия И.О. | автогенерация |
| `{{client_phone}}` | Телефон | Deal.client_phone |
| `{{client_passport_series}}` | Серия паспорта | UserProfile (encrypted) |
| `{{client_passport_number}}` | Номер паспорта | UserProfile (encrypted) |
| `{{client_passport_issued}}` | Кем выдан | UserProfile (encrypted) |
| `{{client_passport_date}}` | Дата выдачи | UserProfile |
| `{{client_address}}` | Адрес регистрации | UserProfile |
| `{{client_email}}` | Email | UserProfile |

### 4.3 Данные договора

| Плейсхолдер | Описание | Формат |
|-------------|----------|--------|
| `{{contract_number}}` | Номер договора | ДУ-2024-XXXXXX |
| `{{contract_date}}` | Дата договора | 24.12.2024 |
| `{{contract_city}}` | Город заключения | г. Москва |
| `{{deal_type}}` | Тип сделки | Покупка вторичной недвижимости |
| `{{property_address}}` | Адрес объекта | полный адрес |
| `{{property_cadastral}}` | Кадастровый номер | XX:XX:XXXXXXX:XXX |
| `{{property_area}}` | Площадь | 45.5 кв.м |
| `{{property_rooms}}` | Количество комнат | 2 |
| `{{property_floor}}` | Этаж | 5 из 17 |

### 4.4 Финансовые данные

| Плейсхолдер | Описание | Формат |
|-------------|----------|--------|
| `{{commission_total}}` | Сумма комиссии | 150 000 |
| `{{commission_words}}` | Сумма прописью | сто пятьдесят тысяч рублей |
| `{{payment_plan_rows}}` | HTML таблица платежей | `<tr>...</tr>` |
| `{{penalty_rate}}` | Ставка неустойки | 0.1% |
| `{{prepayment_amount}}` | Сумма аванса | 50 000 |
| `{{prepayment_percent}}` | Процент аванса | 30% |

### 4.5 Сроки

| Плейсхолдер | Описание | Формат |
|-------------|----------|--------|
| `{{contract_term_months}}` | Срок договора | 6 месяцев |
| `{{contract_end_date}}` | Дата окончания | 24.06.2025 |
| `{{exclusivity_period}}` | Период эксклюзива | 3 месяца |
| `{{claim_period_days}}` | Срок ответа на претензию | 30 дней |
| `{{data_retention_years}}` | Срок хранения ПДн | 3 года |

### 4.6 Технические данные

| Плейсхолдер | Описание |
|-------------|----------|
| `{{document_hash}}` | SHA-256 хеш документа |
| `{{signature_timestamp}}` | Время подписания (ISO) |
| `{{signature_ip}}` | IP адрес подписанта |
| `{{qr_code}}` | QR-код для верификации |

---

## 5. Сценарии и edge cases

### 5.1 Пользовательские сценарии

| Сценарий | Документы | Особенности |
|----------|-----------|-------------|
| Агент работает сам на себя (ИП/самозанятый) | Договор, Акт | Упрощенные реквизиты |
| Агент работает от агентства | Договор (агентство = исполнитель), Акт | Полные реквизиты ЮЛ |
| Несколько клиентов (созаемщики) | Договор с множественными заказчиками | Солидарная ответственность |
| Клиент — юридическое лицо | Договор B2B | Без права потребителя, +НДС |
| Клиент отказался в течение 14 дней | Соглашение о расторжении | Полный возврат |
| Клиент расторгает после начала услуг | Соглашение о расторжении + Акт | Частичный возврат |
| Изменение условий | Доп. соглашение | Ссылка на основной договор |
| Продление срока | Доп. соглашение | Без изменения цены |
| Крупная сделка (>600к руб) | + Идентификация по 115-ФЗ | KYC обязателен |

### 5.2 Технические edge cases

| Случай | Решение |
|--------|---------|
| Плейсхолдер не заполнен | Заменять на "не указано" или блокировать генерацию |
| Сумма = 0 | Блокировать генерацию |
| Нет телефона клиента | Блокировать (нужен для ПЭП) |
| Паспорт не заполнен | Разрешить (заполнить позже) |
| Очень длинный адрес | Перенос строк в PDF |
| Спецсимволы в имени | HTML escaping |

---

## 6. Текущая реализация (Phase 1 - MVP)

### 6.1 Хранение шаблонов

Шаблоны в коде: `backend/app/services/document/generator.py`

### 6.2 Реализованные шаблоны

- [x] `secondary_buy` — Договор на подбор (покупка)
- [x] `secondary_sell` — Договор на продажу
- [x] `newbuild_booking` — Договор на бронирование
- [x] `act` — Акт оказанных услуг
- [ ] `rental_search` — TODO
- [ ] `rental_landlord` — TODO
- [ ] `additional_agreement` — TODO
- [ ] `termination_agreement` — TODO
- [ ] `pd_consent` — TODO (отдельный документ)
- [ ] `pep_consent` — TODO (встроено в договор)

### 6.3 Что нужно доработать в шаблонах

| Шаблон | Недостающее |
|--------|-------------|
| Все | Раздел "Форс-мажор" |
| Все | Раздел "Ограничение ответственности" |
| Все | Полные реквизиты (ОГРН, КПП, банк) |
| Все | Кадастровый номер объекта |
| secondary_sell | Эксклюзивность более детально |
| newbuild_booking | Disclaimer про застройщика |

---

## 7. Целевая реализация (Phase 2)

### 7.1 Модель данных

```sql
CREATE TABLE contract_templates (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    created_at TIMESTAMP DEFAULT now(),
    updated_at TIMESTAMP DEFAULT now(),

    -- Идентификация
    code VARCHAR(50) NOT NULL,            -- secondary_buy, act, etc.
    version VARCHAR(20) NOT NULL,         -- "1.0", "1.1", "2.0"
    name VARCHAR(255) NOT NULL,           -- Отображаемое название
    description TEXT,                      -- Описание для админов

    -- Содержимое
    template_body TEXT NOT NULL,          -- HTML шаблон
    placeholders_schema JSONB NOT NULL,   -- JSON Schema плейсхолдеров

    -- Метаданные
    legal_basis TEXT,                     -- Правовое основание (ссылки на статьи)
    effective_from DATE,                  -- Дата вступления в силу

    -- Статус
    status VARCHAR(20) DEFAULT 'draft',   -- draft, published, archived
    active BOOLEAN DEFAULT false,         -- Используется для новых сделок
    published_at TIMESTAMP,

    -- Аудит
    created_by_user_id INTEGER,
    approved_by_user_id INTEGER,          -- Кто согласовал
    approved_at TIMESTAMP,

    UNIQUE(code, version)
);

-- История изменений
CREATE TABLE contract_template_history (
    id UUID PRIMARY KEY,
    template_id UUID REFERENCES contract_templates(id),
    changed_at TIMESTAMP DEFAULT now(),
    changed_by_user_id INTEGER,
    action VARCHAR(20),                   -- created, updated, published, activated
    old_values JSONB,
    new_values JSONB
);
```

### 7.2 API эндпоинты

```
# Шаблоны
GET    /api/v1/templates                        # Список шаблонов
GET    /api/v1/templates/{id}                   # Получить шаблон
POST   /api/v1/templates                        # Создать новую версию
PUT    /api/v1/templates/{id}                   # Обновить (только draft)
DELETE /api/v1/templates/{id}                   # Удалить (только draft)

# Workflow
POST   /api/v1/templates/{id}/validate          # Проверить HTML и плейсхолдеры
POST   /api/v1/templates/{id}/preview           # Превью с тестовыми данными
POST   /api/v1/templates/{id}/submit-for-review # Отправить на согласование
POST   /api/v1/templates/{id}/approve           # Согласовать (юрист)
POST   /api/v1/templates/{id}/publish           # Опубликовать
POST   /api/v1/templates/{id}/activate          # Сделать активным
POST   /api/v1/templates/{id}/archive           # Архивировать

# История
GET    /api/v1/templates/{id}/history           # История изменений
GET    /api/v1/templates/{id}/versions          # Все версии
```

### 7.3 Workflow статусов

```
draft → pending_review → approved → published → active
                ↓                       ↓
            rejected                archived
```

### 7.4 Права доступа

| Роль | Просмотр | Создание | Редактирование | Согласование | Публикация | Активация |
|------|----------|----------|----------------|--------------|------------|-----------|
| agent | - | - | - | - | - | - |
| agency_admin | + | + | + (draft) | - | - | - |
| legal | + | - | - | + | - | - |
| super_admin | + | + | + | + | + | + |

---

## 8. Валидация шаблонов

### 8.1 При сохранении

- [ ] HTML валидный (парсится без ошибок)
- [ ] Все плейсхолдеры из schema присутствуют в теле
- [ ] Нет неизвестных плейсхолдеров
- [ ] Размер < 500KB

### 8.2 При публикации

- [ ] Прошел согласование юристом
- [ ] Есть обязательные разделы (предмет, цена, сроки)
- [ ] Корректные ссылки на законы
- [ ] PDF генерируется без ошибок

---

## 9. Оценка трудозатрат

| Задача | Часы |
|--------|------|
| Доработка 4 текущих шаблонов (форс-мажор, реквизиты) | 4 |
| Добавление 4 новых шаблонов (аренда, расторжение, доп.соглашение, ПДн) | 8 |
| API для управления шаблонами | 6 |
| Workflow согласования | 4 |
| Admin UI (список, редактор, превью) | 12 |
| Версионирование и история | 4 |
| Тесты | 6 |
| **Итого Phase 2** | **44** |

---

## 10. Риски и митигация

| Риск | Вероятность | Влияние | Митигация |
|------|-------------|---------|-----------|
| Юридические ошибки в шаблонах | Средняя | Высокое | Обязательная проверка юристом |
| Поломка PDF генерации | Низкая | Высокое | Валидация HTML при сохранении |
| Потеря шаблона | Низкая | Высокое | Версионирование, бэкапы |
| Несоответствие изменениям законодательства | Средняя | Среднее | Мониторинг, уведомления |
| Конфликт версий при редактировании | Низкая | Низкое | Optimistic locking |

---

## 11. Чеклист для юридической проверки шаблонов

### Общие требования

- [ ] Корректные ссылки на статьи ГК РФ
- [ ] Упоминание 63-ФЗ (электронная подпись)
- [ ] Упоминание 152-ФЗ (персональные данные)
- [ ] Нет противоречий с Законом о защите прав потребителей
- [ ] Условия не являются кабальными (ст. 179 ГК)

### По разделам

- [ ] Предмет договора — конкретный, измеримый
- [ ] Цена — однозначно определена
- [ ] Сроки — реальные, с возможностью продления
- [ ] Ответственность — соразмерная, с лимитами
- [ ] Расторжение — соответствует ст. 782 ГК
- [ ] Подсудность — законная

### Для B2C (физлица-клиенты)

- [ ] Право на отказ от услуг (ст. 32 ЗоЗПП)
- [ ] Нет условий, ущемляющих права потребителя
- [ ] Информация о исполнителе полная

---

## 12. Статус согласования

| Раздел | Статус | Согласовал | Дата |
|--------|--------|------------|------|
| Архитектура модуля | На согласовании | | |
| Список типов документов | На согласовании | | |
| Структура договора | На согласовании | | |
| Плейсхолдеры | На согласовании | | |
| API контракт | На согласовании | | |
| Текст шаблона secondary_buy | Требует юриста | | |
| Текст шаблона secondary_sell | Требует юриста | | |
| Текст шаблона newbuild_booking | Требует юриста | | |
| Текст шаблона act | Требует юриста | | |

---

## Приложение А: Пример полного договора

См. файл: `backend/app/services/document/generator.py` → `SECONDARY_BUY_TEMPLATE`

## Приложение Б: JSON Schema плейсхолдеров

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "type": "object",
  "required": [
    "contract_number",
    "contract_date",
    "executor_name",
    "executor_inn",
    "client_name",
    "client_phone",
    "property_address",
    "commission_total"
  ],
  "properties": {
    "contract_number": {
      "type": "string",
      "pattern": "^ДУ-\\d{4}-[A-Z0-9]{6}$"
    },
    "contract_date": {
      "type": "string",
      "format": "date"
    },
    "commission_total": {
      "type": "number",
      "minimum": 1000
    }
  }
}
```
