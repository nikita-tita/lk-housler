# API Payments Guide - Housler lk.housler.ru

## üí∞ Payment Endpoints

### 1. –°–æ–∑–¥–∞–Ω–∏–µ Payment Intent

–°–æ–∑–¥–∞–µ—Ç –Ω–∞–º–µ—Ä–µ–Ω–∏–µ –Ω–∞ –æ–ø–ª–∞—Ç—É –¥–ª—è —Å–¥–µ–ª–∫–∏.

```bash
POST /api/v1/payments/intents
Authorization: Bearer {access_token}
Content-Type: application/json

{
  "deal_id": "550e8400-e29b-41d4-a716-446655440000",
  "amount": 500000,  // –≤ –∫–æ–ø–µ–π–∫–∞—Ö (5000 —Ä—É–±)
  "description": "–û–ø–ª–∞—Ç–∞ –ø–æ –¥–æ–≥–æ–≤–æ—Ä—É ‚Ññ123"
}
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "payment_intent_id": "660e8400-e29b-41d4-a716-446655440000",
  "payment_url": "https://sbp.example.com/pay/xxx",
  "amount": 500000,
  "status": "created"
}
```

---

### 2. –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞

```bash
GET /api/v1/payments/{payment_id}
Authorization: Bearer {access_token}
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "id": "660e8400-e29b-41d4-a716-446655440000",
  "deal_id": "550e8400-e29b-41d4-a716-446655440000",
  "amount": 500000,
  "status": "succeeded",
  "payment_method": "sbp",
  "created_at": "2025-12-23T10:00:00Z",
  "completed_at": "2025-12-23T10:05:30Z"
}
```

**–í–æ–∑–º–æ–∂–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã:**
- `created` - –°–æ–∑–¥–∞–Ω
- `pending` - –û–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã
- `succeeded` - –£—Å–ø–µ—à–Ω–æ –æ–ø–ª–∞—á–µ–Ω
- `failed` - –û—à–∏–±–∫–∞
- `canceled` - –û—Ç–º–µ–Ω–µ–Ω

---

### 3. Webhook –æ—Ç –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã

**–í–∞–∂–Ω–æ:** Endpoint –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ—Ç –°–ë–ü/–±–∞–Ω–∫–∞.

```bash
POST /api/v1/payments/webhooks
Content-Type: application/json
X-Webhook-Signature: {signature}  // TODO: –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∏

{
  "payment_id": "660e8400-e29b-41d4-a716-446655440000",
  "status": "succeeded",
  "provider_payment_id": "sbp_123456789"
}
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "status": "ok"
}
```

---

## üîÑ –§–ª–æ—É –æ–ø–ª–∞—Ç—ã

### –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å

```
1. –ö–ª–∏–µ–Ω—Ç —Å–æ–∑–¥–∞–µ—Ç —Å–¥–µ–ª–∫—É
   ‚Üí Deal —Å–æ–∑–¥–∞–Ω

2. Backend —Å–æ–∑–¥–∞–µ—Ç Payment Intent
   POST /api/v1/payments/intents
   ‚Üí –ü–æ–ª—É—á–∞–µ–º payment_url

3. –ö–ª–∏–µ–Ω—Ç –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –ø–æ payment_url
   ‚Üí –û–ø–ª–∞—á–∏–≤–∞–µ—Ç —á–µ—Ä–µ–∑ –°–ë–ü

4. –°–ë–ü –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç webhook
   POST /api/v1/payments/webhooks
   ‚Üí Status –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è

5. Backend —Å–æ–∑–¥–∞–µ—Ç –ø—Ä–æ–≤–æ–¥–∫–∏ (Ledger)
   ‚Üí –î–µ–Ω—å–≥–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è –ø–æ Split

6. Backend –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —á–µ–∫–∏ (NPD)
   ‚Üí –û—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –≤ –§–ù–°
```

---

## üí∏ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ (–°–ë–ü Split)

### –°—Ö–µ–º–∞ –∫–æ–º–∏—Å—Å–∏–π (–∏–∑ –¢–ó)

**–†–∏–µ–ª—Ç–æ—Ä –ø–æ–ª—É—á–∞–µ—Ç:**
- 100% –æ—Ç –∫–æ–º–∏—Å—Å–∏–∏ –º–∏–Ω—É—Å:
  - –ù–î–° 20% (–µ—Å–ª–∏ —é—Ä. –ª–∏—Ü–æ)
  - –ö–æ–º–∏—Å—Å–∏—è –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã 1-3%
  - –ö–æ–º–∏—Å—Å–∏—è –∞–≥–µ–Ω—Ç—Å—Ç–≤–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)

**–ü—Ä–∏–º–µ—Ä:**
```
–ö–æ–º–∏—Å—Å–∏—è: 300 000 —Ä—É–±
–ù–î–° (20%): -50 000 —Ä—É–±
–ö–æ–º–∏—Å—Å–∏—è –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã (2%): -6 000 —Ä—É–±
–ö–æ–º–∏—Å—Å–∏—è –∞–≥–µ–Ω—Ç—Å—Ç–≤–∞ (30%): -73 200 —Ä—É–±

‚Üí –†–∏–µ–ª—Ç–æ—Ä –ø–æ–ª—É—á–∞–µ—Ç: 170 800 —Ä—É–±
‚Üí –ê–≥–µ–Ω—Ç—Å—Ç–≤–æ –ø–æ–ª—É—á–∞–µ—Ç: 73 200 —Ä—É–±
‚Üí –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –ø–æ–ª—É—á–∞–µ—Ç: 6 000 —Ä—É–±
‚Üí –ù–î–° –≤ –±—é–¥–∂–µ—Ç: 50 000 —Ä—É–±
```

---

## üßæ –ß–µ–∫–∏ (–ù–ü–î)

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:

1. **–°–æ–∑–¥–∞–µ—Ç –∑–∞–¥–∞—á—É NPDTask**
   - –¢–∏–ø: `receipt`
   - –°—Ç–∞—Ç—É—Å: `pending`

2. **–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —á–µ–∫ —á–µ—Ä–µ–∑ API –§–ù–°**
   - –î–ª—è —Å–∞–º–æ–∑–∞–Ω—è—Ç—ã—Ö (–ù–ü–î)
   - –° QR-–∫–æ–¥–æ–º

3. **–°–æ—Ö—Ä–∞–Ω—è–µ—Ç Receipt**
   - PDF —á–µ–∫–∞
   - URL –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

4. **–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç Email/SMS**
   - –ö–ª–∏–µ–Ω—Ç—É
   - –†–∏–µ–ª—Ç–æ—Ä—É

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### Merchant of Record (MoR)

**–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –≤—ã—Å—Ç—É–ø–∞–µ—Ç MoR:**
- –û–û–û "–°–µ–∫—Ç–æ—Ä –ò–¢" (–ò–ù–ù 5190237491)
- –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –≤—Å–µ –ø–ª–∞—Ç–µ–∂–∏
- –ó–∞—Ç–µ–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º

### Antifraud –ø—Ä–æ–≤–µ—Ä–∫–∏

–ü–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º Payment Intent:

1. **KYC/AML –ø—Ä–æ–≤–µ—Ä–∫–∞ (115-–§–ó)**
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –ò–ù–ù
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–Ω–∫–æ–≤—Å–∫–∏—Ö —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ —á–µ—Ä–Ω—ã—Ö —Å–ø–∏—Å–∫–∞—Ö

2. **–õ–∏–º–∏—Ç—ã**
   - –î–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - –ú–µ—Å—è—á–Ω—ã–π –ª–∏–º–∏—Ç
   - –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ —Å–¥–µ–ª–∫–∏

3. **Risk Score**
   - –ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π
   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∫–ª–æ–Ω–µ–Ω–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π
   - –ñ–∞–ª–æ–±—ã

---

## üìä Ledger (–ë—É—Ö–≥–∞–ª—Ç–µ—Ä—Å–∫–∏–µ –ø—Ä–æ–≤–æ–¥–∫–∏)

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞

–ö–∞–∂–¥—ã–π –ø–ª–∞—Ç–µ–∂ —Å–æ–∑–¥–∞–µ—Ç:

1. **LedgerEntry** (–≥–ª–∞–≤–Ω–∞—è –∑–∞–ø–∏—Å—å)
   - `transaction_id` - UUID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
   - `entry_type` - —Ç–∏–ø (payment, commission, tax)
   - `amount` - —Å—É–º–º–∞

2. **Split** (—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ)
   - `user_id` - –∫–æ–º—É
   - `amount` - —Å–∫–æ–ª—å–∫–æ
   - `split_type` - —Ç–∏–ø (agent_commission, agency_commission, platform_fee, tax)

### –ü—Ä–∏–º–µ—Ä

```json
{
  "transaction_id": "tx_123",
  "entry_type": "payment",
  "amount": 300000,
  "splits": [
    {
      "user_id": "agent_1",
      "amount": 170800,
      "split_type": "agent_commission"
    },
    {
      "user_id": "agency_1",
      "amount": 73200,
      "split_type": "agency_commission"
    },
    {
      "user_id": "platform",
      "amount": 6000,
      "split_type": "platform_fee"
    },
    {
      "user_id": "tax_authority",
      "amount": 50000,
      "split_type": "tax"
    }
  ]
}
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### Mock Payment Provider

–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Mock:

```python
# backend/app/services/payment/provider.py
class MockPaymentProvider:
    async def create_payment_intent(...):
        return {
            "provider_intent_id": f"mock_{uuid4().hex[:8]}",
            "sbp_link": "https://mock-sbp.local/pay/xxx"
        }
```

### –≠–º—É–ª—è—Ü–∏—è webhook

```bash
# –£—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞
curl -X POST http://localhost:8000/api/v1/payments/webhooks \
  -H "Content-Type: application/json" \
  -d '{
    "payment_id": "660e8400-e29b-41d4-a716-446655440000",
    "status": "succeeded",
    "provider_payment_id": "test_payment_123"
  }'
```

---

## üéØ TODO –¥–ª—è Production

- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Ä–µ–∞–ª—å–Ω—ã–º –°–ë–ü API
- [ ] –í–∞–ª–∏–¥–∞—Ü–∏—è webhook signature
- [ ] Retry –º–µ—Ö–∞–Ω–∏–∑–º –¥–ª—è webhook
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π
- [ ] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —á–µ–∫–æ–≤ —á–µ—Ä–µ–∑ –§–ù–° API
- [ ] Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞
- [ ] SMS —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- [ ] Dashboard –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–µ–π

