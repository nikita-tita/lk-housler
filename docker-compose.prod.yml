version: '3.8'

# Production Docker Compose for lk.housler.ru
# Uses shared database with agent.housler.ru for unified auth
# Deploy: docker-compose -f docker-compose.prod.yml up -d

services:
  # Redis (local for lk cache)
  redis:
    image: redis:7-alpine
    container_name: lk-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis_data:/data
    healthcheck:
      test: [ "CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping" ]
      interval: 10s
      timeout: 3s
      retries: 3
    networks:
      - lk-network

  # MinIO (S3-compatible storage)
  minio:
    image: minio/minio:latest
    container_name: lk-minio
    restart: unless-stopped
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
    volumes:
      - minio_data:/data
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:9000/minio/health/live" ]
      interval: 30s
      timeout: 20s
      retries: 3
    networks:
      - lk-network

  # Backend (FastAPI) - connects to agent-postgres for unified auth
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: lk-backend
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - APP_ENV=production
      - DEBUG=false
      # Use agent-postgres from agent.housler.ru network
      - DB_HOST=agent-postgres
      - DB_PORT=5432
      - DB_NAME=housler_agent
      - DB_USER=housler
      - DB_PASSWORD=${DB_PASSWORD}
      - DATABASE_URL=postgresql+asyncpg://housler:${DB_PASSWORD}@agent-postgres:5432/housler_agent
      - DATABASE_URL_SYNC=postgresql://housler:${DB_PASSWORD}@agent-postgres:5432/housler_agent
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379/0
      - CELERY_BROKER_URL=redis://:${REDIS_PASSWORD}@redis:6379/1
      - CELERY_RESULT_BACKEND=redis://:${REDIS_PASSWORD}@redis:6379/2
      - S3_ENDPOINT=http://minio:9000
      - S3_ACCESS_KEY=${MINIO_ROOT_USER:-minioadmin}
      - S3_SECRET_KEY=${MINIO_ROOT_PASSWORD}
      - JWT_SECRET=${JWT_SECRET}
      - JWT_SECRET_KEY=${JWT_SECRET}
      - SECRET_KEY=${JWT_SECRET}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
      - ENCRYPTION_SALT=${ENCRYPTION_SALT}
      - FRONTEND_URL=https://lk.housler.ru
      - CORS_ORIGINS=https://lk.housler.ru
      - SMS_PROVIDER=${SMS_PROVIDER:-sms_ru}
      - SMS_RU_API_ID=${SMS_RU_API_ID}
      - SMS_TEST_MODE=${SMS_TEST_MODE:-false}
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ROOT_USER=${MINIO_ROOT_USER:-minioadmin}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD:-minioadmin}
      # TBank Integration
      - TBANK_API_URL=${TBANK_API_URL:-https://api.tbank.ru}
      - TBANK_TERMINAL_KEY=${TBANK_TERMINAL_KEY}
      - TBANK_SECRET_KEY=${TBANK_SECRET_KEY}
      - TBANK_USE_MOCK=${TBANK_USE_MOCK:-false}
      - TBANK_HOLD_PERIOD_SECONDS=${TBANK_HOLD_PERIOD_SECONDS:-3600}
      # Feature flags
      - INSTANT_SPLIT_ENABLED=${INSTANT_SPLIT_ENABLED:-false}
      - INSTANT_SPLIT_ORG_IDS=${INSTANT_SPLIT_ORG_IDS:-}
    volumes:
      - ./logs/backend:/app/logs
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - lk-network
      - agent-network

  # Celery Worker for background tasks
  celery-worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: lk-celery-worker
    restart: unless-stopped
    command: celery -A app.tasks.celery_app worker --loglevel=info --concurrency=2
    env_file:
      - .env
    environment:
      - APP_ENV=production
      - DATABASE_URL=postgresql+asyncpg://housler:${DB_PASSWORD}@agent-postgres:5432/housler_agent
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379/0
      - CELERY_BROKER_URL=redis://:${REDIS_PASSWORD}@redis:6379/1
      - CELERY_RESULT_BACKEND=redis://:${REDIS_PASSWORD}@redis:6379/2
      - TBANK_API_URL=${TBANK_API_URL:-https://api.tbank.ru}
      - TBANK_TERMINAL_KEY=${TBANK_TERMINAL_KEY}
      - TBANK_SECRET_KEY=${TBANK_SECRET_KEY}
      - TBANK_USE_MOCK=${TBANK_USE_MOCK:-false}
    depends_on:
      - redis
      - backend
    networks:
      - lk-network
      - agent-network

  # Celery Beat for scheduled tasks
  celery-beat:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: lk-celery-beat
    restart: unless-stopped
    command: celery -A app.tasks.celery_app beat --loglevel=info
    env_file:
      - .env
    environment:
      - APP_ENV=production
      - DATABASE_URL=postgresql+asyncpg://housler:${DB_PASSWORD}@agent-postgres:5432/housler_agent
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379/0
      - CELERY_BROKER_URL=redis://:${REDIS_PASSWORD}@redis:6379/1
    depends_on:
      - redis
      - celery-worker
    networks:
      - lk-network

  # Frontend (Next.js)
  frontend:
    build:
      context: .
      dockerfile: apps/lk/Dockerfile
      args:
        NEXT_PUBLIC_API_URL: https://lk.housler.ru
    container_name: lk-frontend
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_API_URL=https://lk.housler.ru
    depends_on:
      - backend
    healthcheck:
      test: [ "CMD", "node", "-e", "fetch('http://localhost:3000').then(r => process.exit(r.ok ? 0 : 1)).catch(() => process.exit(1))" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - lk-network

  # Nginx reverse proxy
  nginx:
    image: nginx:alpine
    container_name: lk-nginx
    restart: unless-stopped
    ports:
      - "127.0.0.1:3090:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - backend
      - frontend
    networks:
      - lk-network

volumes:
  redis_data:
    driver: local
  minio_data:
    driver: local

networks:
  lk-network:
    driver: bridge
  # External network to access agent-postgres
  agent-network:
    external: true
    name: housler_agent_network # Must match agent.housler.ru network name
