# Задачи для TPM — lk.housler.ru

**Дата:** 2026-01-17
**Обновлено:** 2026-01-17 (после выполнения Этапов 1-2)

---

## КАРТА ЭТАПОВ И ЗАВИСИМОСТЕЙ

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        DEPENDENCY MAP                                    │
└─────────────────────────────────────────────────────────────────────────┘

ЭТАП 1 (Параллельно - нет зависимостей)          СТАТУС: DONE
├── CODE-001: housler-crypto ─────────────────── [x] DONE
├── CODE-002: Legacy auth endpoints ──────────── [x] DONE
├── DOC-003: SHARED_DATABASE.md ──────────────── [x] DONE
└── DOC-004: DEVELOPMENT.md ──────────────────── [x] DONE
         │
         ▼
ЭТАП 2 (Параллельно - зависит от Этапа 1)        СТАТУС: DONE
├── CODE-003: Rate limiting phone+IP ─────────── [x] DONE
├── CODE-004: Global error handler ───────────── [x] DONE
└── ARCH-001: Request tracing X-Request-ID ───── [x] DONE
         │
         ▼
ЭТАП 3 (Последовательно - зависит от 1-2)        СТАТУС: PENDING
├── 3.1: Run tests locally ───────────────────── [ ] TODO
├── 3.2: Build docker images ─────────────────── [ ] TODO (depends on 3.1)
├── 3.3: Deploy to staging ───────────────────── [ ] TODO (depends on 3.2)
├── 3.4: Smoke tests on staging ──────────────── [ ] TODO (depends on 3.3)
└── 3.5: E2E tests on staging ────────────────── [ ] TODO (depends on 3.4)
         │
         ▼
ЭТАП 4 (Зависит от T-Bank credentials)           СТАТУС: BLOCKED
├── 4.1: Get T-Bank sandbox credentials ──────── [ ] BLOCKED (Business)
├── 4.2: Test bank-split on sandbox ──────────── [ ] TODO (depends on 4.1)
├── 4.3: Get T-Bank production credentials ───── [ ] BLOCKED (Contract)
└── 4.4: Production deploy ───────────────────── [ ] TODO (depends on 4.3)
```

---

## ВЫПОЛНЕННЫЕ ЗАДАЧИ

### ЭТАП 1: Критические фиксы (DONE)

| ID | Задача | Статус | Изменения |
|----|--------|--------|-----------|
| CODE-001 | housler-crypto в requirements | DONE | `backend/requirements.txt:28` |
| CODE-002 | Legacy auth endpoints | DONE | `backend/app/api/v1/endpoints/auth.py` - возвращают 400 |
| DOC-003 | SHARED_DATABASE.md | DONE | `docs/SHARED_DATABASE.md` создан |
| DOC-004 | DEVELOPMENT.md | DONE | `docs/DEVELOPMENT.md` создан |

### ЭТАП 2: Code quality (DONE)

| ID | Задача | Статус | Изменения |
|----|--------|--------|-----------|
| CODE-003 | Rate limiting phone+IP | DONE | `backend/app/core/rate_limit.py` + `auth.py` |
| CODE-004 | Global error handler | DONE | `backend/app/main.py` - 3 handlers |
| ARCH-001 | Request tracing | DONE | `backend/app/main.py` - X-Request-ID middleware |

---

## СЛЕДУЮЩИЕ ШАГИ: ЭТАП 3

### 3.1 Запуск тестов локально

```bash
cd backend
source venv/bin/activate
pytest --tb=short
```

**Ожидаемый результат:** 111+ passed

### 3.2 Сборка docker images

```bash
docker compose -f docker-compose.prod.yml build
```

### 3.3 Deploy на staging

```bash
ssh -i ~/.ssh/id_housler root@95.163.227.26
cd /root/lk-housler
git pull origin main
docker compose -f docker-compose.prod.yml up -d --build
```

### 3.4 Smoke tests

```bash
# Health check
curl https://lk.housler.ru/api/health

# Auth check (должен вернуть 400 с сообщением о deprecated)
curl -X POST https://lk.housler.ru/api/v1/auth/otp/send \
  -H "Content-Type: application/json" \
  -d '{"phone": "+79999123456"}'
```

### 3.5 E2E tests (если настроены)

```bash
cd e2e
npm test
```

---

## БЛОКЕРЫ

| ID | Блокер | Владелец | Статус |
|----|--------|----------|--------|
| BLOCK-001 | T-Bank sandbox credentials | TPM-LK | Запросить |
| BLOCK-002 | T-Bank production contract | Business | Ожидание |
| BLOCK-003 | housler-crypto в PyPI | DevOps | HC-PUB-001 |

---

## ИЗМЕНЁННЫЕ ФАЙЛЫ (сессия 2026-01-17)

```
MODIFIED:
├── backend/requirements.txt              # housler-crypto uncommented
├── backend/app/api/v1/endpoints/auth.py  # legacy endpoints return 400
├── backend/app/core/rate_limit.py        # phone+email rate limiting
├── backend/app/main.py                   # error handlers + X-Request-ID
├── README.md                             # fixed links, IP
├── DEPLOY.md                             # fixed IP
└── team/TEAM.md                          # updated status

CREATED:
├── docs/SHARED_DATABASE.md               # shared DB documentation
├── docs/DEVELOPMENT.md                   # local development guide
└── team/TASKS_2026-01-17.md              # this file
```

---

## МЕТРИКИ СЕССИИ

| Метрика | Значение |
|---------|----------|
| Задач выполнено | 8 |
| Файлов изменено | 7 |
| Файлов создано | 3 |
| Критических фиксов | 2 |
| Документов создано | 2 |

---

## КОМАНДА: СЛЕДУЮЩИЕ НАЗНАЧЕНИЯ

| Роль | Задача | Срок |
|------|--------|------|
| BE-LK | Запустить тесты, проверить сборку | Сегодня |
| DevOps | Deploy на staging | После тестов |
| QA-LK | Smoke tests на staging | После deploy |
| TPM-LK | Запросить T-Bank sandbox credentials | Сегодня |
| Business | Договор с T-Bank | Ongoing |

---

*Создано: 2026-01-17*
*Последнее обновление: 2026-01-17*
